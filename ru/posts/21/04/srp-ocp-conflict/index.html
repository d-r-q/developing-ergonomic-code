<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Анкл Боб не всегда прав - Алексей Жидков"><meta property="og:description" content="Применение OCP в классическом виде может повлечь за собой нарушение SRP и повышенный риск регрессий."><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/posts/21/04/srp-ocp-conflict/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/posts/21/04/srp-ocp-conflict/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/posts/21/04/srp-ocp-conflict/><title>Анкл Боб не всегда прав - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/posts/21/04/srp-ocp-conflict/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/book/ergo>Книга</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li><li class=multilingual-separator><p>|</p></li><li class="navigation-item align-left"><a href=https://azhidkov.pro/>En</a></li></ul></label></section></nav><div class=content><section class="container post"><article><header><h1 class=title>Анкл Боб не всегда прав</h1><h2 class=date>April 28, 2021</h2></header><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Следить за обновлениями блога можно в моём канале: <a href=https://t.me/ergonomic_code>Эргономичный код</a></p></aside><section class="doc-section level-1"><h2 id=_свежий_пост_анкл_боба>Свежий пост Анкл Боба</h2><p>Прочитал <a href=https://blog.cleancoder.com/uncle-bob/2021/03/06/ifElseSwitch.html>свежий пост Анкл Боба</a> и я с ним категорически не согласен.</p><p>Краткое содержание поста:</p><div class="olist arabic"><ol class=arabic><li><p>Где-то в интернете спросили как зарефакторить код:</p><div class=image-block><img src=/posts/21/04/srp-ocp-conflict-197cb.png alt="srp ocp conflict 197cb"></div></li><li><p>Анкл Боб сказал, что правильно инкапсулировать этот иф в фабрику:</p><div class=image-block><img src=/posts/21/04/srp-ocp-conflict-f5d0e.png alt="srp ocp conflict f5d0e"></div></li></ol></div><p>И далее он пишет:</p><div class=quote-block><blockquote><p>Every business rule that would once have depended on an if/else/switch statement now has its own particular method to call in the base class</p><footer>— <cite>Uncle Bob, https://blog.cleancoder.com/uncle-bob/2021/03/06/ifElseSwitch.html</cite></footer></blockquote></div><p>В общем случае, это решение может быть хорошим дизайном или хотя бы разумным компромиссом.
Но в изначальном примере он не является ни хорошим дизайном, ни разумным компромиссом.</p><p>С этим дизайном в контексте изначальной задачи с полами я вижу две основные проблемы:</p><div class="olist arabic"><ol class=arabic><li>Он повлечёт за собой нарушение SRP;</li><li>Он повлечёт за собой регрессии.</li></ol></div><p>Давайте разбираться и начнём с SRP</p></section><section class="doc-section level-1"><h2 id=_божественные_объекты>Божественные объекты</h2><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Немного спекуляции</p><p>В своём посте Анкл Боб привёл абстрактный дизайн, вынуждая читателей спекулировать.</p><p>И я полагаю, что на второй картинке:</p><div class="olist arabic"><ol class=arabic><li>BaseClass = Gender;</li><li>LLA = Male;</li><li>LLB = Female;</li><li>LLC = Unknown.</li></ol></div></aside><p>Я с лёгкостью могу себе представить, что в одной программе в зависимости от пола надо:</p><div class="olist arabic"><ol class=arabic><li>Сгенерировать аватар в UI;</li><li>заложить дополнительный бюджет, на случай декрета женщины.</li></ol></div><p>Оба этих метода придётся добавить в класс Gender.
И это будет нарушением SRP в любой его интерпретации.</p><p>Если вы дочитали статью до конца, то там в последнем предложении упоминается Acyclic Visitor Pattern, для решения проблемы перекомпиляции клиентов Gender-а.
Он же может помочь и с нарушеним SRP - в этом случае на каждое правило надо будет завести по интерфейсу и три его реализации.
А если появится новый пол, то по новой реализации каждого интерфейса.</p><p>Тут я снова могу только спекулировать, но судя по тому, что Анкл Боб собирается расширять базовый класс, речь идёт о <a href=https://martinfowler.com/ieeeSoftware/published.pdf>неопубликованном</a> классе.</p><p>И если это так, то мало кто станет разводить все эти церемонии с визитором.
А если станет, то на пятой четвёрке классов поймёт что визитор стоит слишком дорого для этой задачи и выкосит его.
И хорошо если подумают при этом, а не засунут всё в один класс.
Но об этом позже.</p></section><section class="doc-section level-1"><h2 id=_квантовая_запутанность>Квантовая запутанность</h2><p>Вторая проблема вызвана тем, что связанная (cohesive) логика раскиданна в пространстве.
Как минимум по разным классам.
А может быть и разным пакетам и модулям - Анкл Боб ничего не говорит об ограничении иерархии полов.</p><p>При том критикуя вариант с ифами они пишет:</p><div class=quote-block><blockquote><p>The fact that they are replicated in many places is problematic because when such statements are inevitably changed, it is easy to miss some.
This leads to fragile systems.</p><footer>— <cite>Uncle Bob</cite></footer></blockquote></div><p>Но предлагает буквально тоже самое, только в другой плоскости!</p><p>Отсюда же и проблемы с анализом кода - разбираясь, как работает генерация аватара, придётся постоянно скакать между тремя файлами.</p></section><section class="doc-section level-1"><h2 id=_а_как_по_другому>А как по другому</h2><p>Лет пятнадцать назад (и с теми же мозгами), я бы не сомневаясь ответил: я тут предвижу больше количество новых операций, и никаких новых вариантов - естественно тут надо использовать алгебраические типы данных.</p><p>Сегодня я бы посомневался, но всё равно выбрал бы АДТ - появление нового пола я представить могу, но пока только теоретически.
А вот новые операции будут точно.</p><p>В современных языках (и даже Java, <a href=https://openjdk.java.net/jeps/397>почти</a>), в случае АДТ компиляторы дают такую же безопасность на этапе компиляции, как и в случае интерфейсов.
При добавлении нового типа программа не скомпилируется, пока все ифы/свичи не обработают его.</p><p>Касательно направления зависимостей, ничего не мешает HighLevel-у зависеть не от конкретной функции, а от абстрактной функции:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=kd>class</span> <span class=nc>UI</span><span class=p>(</span><span class=k>private</span> <span class=kd>val</span> <span class=py>generateAvatar</span><span class=p>:</span> <span class=p>(</span><span class=nc>Gender</span><span class=p>)</span> <span class=p>-&gt;</span> <span class=nc>Image</span><span class=p>)</span></code></pre></div><p>если очень хочется, её можно обернуть в <code>IAvatarGenerator</code> и реализовать в <code>AvatarGeneratorImpl</code>.</p><p>Но самое главное, что в этом случае, метод генерации аватра останется в UI-слое, а метод расчёта бюджета - в слое сервисов.
И их код будет помещаться на одном экране.</p></section></article><br></section></div></main><script src=/js/app.js></script></body></html>