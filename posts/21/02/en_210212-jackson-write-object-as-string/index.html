<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Non-Ergonomic Jackson - Алексей Жидков"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/posts/21/02/en_210212-jackson-write-object-as-string/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/posts/21/02/en_210212-jackson-write-object-as-string/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/posts/21/02/en_210212-jackson-write-object-as-string/><title>Non-Ergonomic Jackson - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/posts/21/02/en_210212-jackson-write-object-as-string/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/book/ergo>Книга</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li><li class=multilingual-separator><p>|</p></li><li class="navigation-item align-left"><a href=https://azhidkov.pro/en/>En</a></li></ul></label></section></nav><div class=content><section class="container post"><article><header><h1 class=title>Non-Ergonomic Jackson</h1><h2 class=date>February 23, 2021</h2></header><p>Recently, I’ve written this code (or something like that) to serialize a JSON object via <a href=https://github.com/FasterXML/jackson>Jackson</a>:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=java><span class=kd>public</span> <span class=nc>String</span> <span class=nf>renderToJson</span><span class=o>(</span><span class=nc>Object</span> <span class=n>dto</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>objectMapper</span><span class=o>.</span><span class=na>writeValueAsString</span><span class=o>(</span><span class=n>dto</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=nc>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=nf>AssertionError</span><span class=o>(</span><span class=s>&#34;Unexpected IOException converting object to json&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span></code></pre></div><p>It was almost offensive to my eye.
I was creating a string object in memory.
What the heck would that have to do with IO?
I had no time to ponder about this, though.</p><p>So there I was reading
<a href=https://softwareengineering.stackexchange.com/questions/147059/the-modern-way-to-perform-error-handling>The
modern way to perform error handling</a>.
And voila, here’s the answer, emerging right from the depths of my mind!
You know what?
That’s still the same topic of mixing policies with effects, and all the problems rooted in this.</p><p><mark>todo: поменять ссылку на внутреннюю</mark>
If you take a deep look at <code>writeValueAsString’s inner workings, you’ll see that this
<a href=https://telegra.ph/CHistye-i-gryaznye-funkcii-ehffekty-i-obrabotka-signalov-sajdehffekty-chistye-funkcii-01-12>pure</a>—per
se—method is just a wrap for `_writeValueAndClose(JsonGenerator g, Object value)</code>.</p><p>g in turn is a wrap for <code>java.io.Writer</code>.
Then you have Writer throwing the <code>java.io.IOException</code>.
Boom, there goes your IOException when you’re generating a string in memory.</p><p>The cause of that problem is this: the policy and the effects are jumbled into one function
(namely, _writeValueAndClose).
The former defines the set of rules according to which the JSON gets formed, based on the Java object.
The latter writes the result into the abstract receiver.</p><p><mark>поменять ссылку на внутреннюю</mark>
To make this code
<a href=https://github.com/d-r-q/developing-ergonomic-code/blob/master/book-rus/developing-ergonomic-code.adoc>ergonomic</a>,
we have to keep these two apart:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=k>fun</span> <span class=nf>transform</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nc>Any</span><span class=p>):</span> <span class=nc>Sequence</span><span class=p>&lt;</span><span class=nc>Char</span><span class=p>&gt;</span> <span class=p>=</span>
  <span class=c1>// the intricate yet clean algorithm that re-renders the json</span>

<span class=k>fun</span> <span class=nf>writeValueAsString</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nc>Any</span><span class=p>)</span> <span class=p>=</span> <span class=nf>transform</span><span class=p>(</span><span class=n>value</span><span class=p>).</span><span class=nf>joinToString</span><span class=p>()</span>

<span class=nd>@Throws</span><span class=p>(</span><span class=nc>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
<span class=k>fun</span> <span class=nf>writeValue</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nc>Any</span><span class=p>,</span> <span class=n>w</span><span class=p>:</span> <span class=nc>Writer</span><span class=p>)</span> <span class=p>=</span> <span class=nf>transform</span><span class=p>(</span><span class=n>value</span><span class=p>).</span><span class=nf>forEach</span> <span class=p>{</span> <span class=n>w</span><span class=p>.</span><span class=nf>append</span><span class=p>(</span><span class=n>it</span><span class=p>)</span> <span class=p>}</span></code></pre></div><p><mark>todo поменять ссылку на внутреннюю</mark>
It’s still the same
<a href=https://github.com/d-r-q/developing-ergonomic-code/blob/master/book-rus/developing-ergonomic-code.adoc#%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D1%8E%D0%B7-%D0%BA%D0%B5%D0%B9%D1%81%D0%B0>ergonomic
(rus)</a>
(aka <a href=https://fsharpforfunandprofit.com/rop/>ROP</a>, aka
<a href="https://www.youtube.com/watch?v=yTkzNHF6rMs">Functional Core/Imperative Shell</a>) pattern.
I haven’t discussed it yet.
The key idea is to keep all these apart:</p><div class="olist arabic"><ol class=arabic><li>the business logic (transform),</li><li>the effective port (Writer), and</li><li>the usecase/workflow bridging the two (writeValueAsString, writeValue).</li></ol></div><p>Keeping the logic and the effects separated is like giving your users letter cubes for them to build
their own use cases.
The ones that seem most common can come out of the box.</p><p>It’s not like I’m bashing the team behind Jackson.
I see at least three reasons everything is the way it is:</p><div class="olist arabic"><ol class=arabic><li>I’m not sure the sequences-based option can be as fast as the one where you write everything
straight into the output stream, which is critical for them.</li><li>It’s highly likely that back when they were writing this code, the functional paradigm hadn’t yet
got in fashion, so Java simply had no
<a href=https://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html>Stream API</a>.</li><li>It’s quite hard to come up with a good design straight away.
If you’re the author behind a popular open source library and have any respect for your users, you’ll
be stuck with the mistakes of your youth forever for one simple reason: backward compatibility.</li></ol></div><p>Luckily, we have quite a lot under our belt here.
We know of the ergonomic approach, have learned from others' mistakes, and are armed with a sequence
library.
All of this means we can design our app to be ergonomic from the very start.
If we can afford that performance-wise, of course.</p><p>I’ve written this post primarily with libraries development (Jackson) in mind.
Everything I said can be used in app development as well, though.
The system’s core or domain <s>should</s> can be viewed as a standard library used by your
app.
The main advantage to this approach is that a good library can be used by lots of apps, and you will
normally have at least two—the main app and the tests.
I’ll cover the details of viewing the domain module as a library some other time, though.
It’s worthy of its own dedicated post. :) <span class=logo><img src=/images/logo.svg alt=logo></span></p><hr><p>P.S. Perhaps you’ll say that a lazy Sequence isn’t the same as a eager Writer, and you’ll always
<s>have a harder time</s> will be less used to writing this way.
Thanks to coroutines, though, even that’s not true:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=kd>val</span> <span class=py>obj</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
<span class=kd>val</span> <span class=py>seq</span> <span class=p>=</span> <span class=n>sequence</span><span class=p>&lt;</span><span class=nc>Char</span><span class=p>&gt;</span> <span class=p>{</span>
    <span class=k>yield</span><span class=p>(</span><span class=sc>&#39;{&#39;</span><span class=p>)</span>
    <span class=n>obj</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>memberProperties</span><span class=p>.</span><span class=nf>forEach</span> <span class=p>{</span>
        <span class=nf>yieldAll</span><span class=p>(</span><span class=s>&#34;\&#34;${it.name}\&#34;: ${it.call()}&#34;</span><span class=p>.</span><span class=nf>asSequence</span><span class=p>())</span>
    <span class=p>}</span>
    <span class=k>yield</span><span class=p>(</span><span class=sc>&#39;}&#39;</span><span class=p>)</span>
<span class=p>}</span></code></pre></div></article><br></section></div></main><script src=/js/app.js></script></body></html>