<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Разработка эргономичного кода"><meta property="og:title" content="Неэргономичный Jackson - Разработка эргономичного кода"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/posts/210212-jackson-write-object-as-string/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/posts/210212-jackson-write-object-as-string/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/posts/210212-jackson-write-object-as-string/><title>Неэргономичный Jackson - Разработка эргономичного кода</title><link rel=canonical href=https://azhidkov.pro/posts/210212-jackson-write-object-as-string/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Разработка эргономичного кода"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Разработка эргономичного кода"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Разработка эргономичного кода</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/book/developing-ergonomic-code>Эрго-Книга</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Эрго-Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/services>Услуги</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li></ul></label></section></nav><div class=content><section class="container post"><article><header><h1 class=title>Неэргономичный Jackson</h1><h2 class=date>February 23, 2021</h2></header><p>В последнее вермя несколько раз писал примерно такой код для сериализации объекта в json <a href=https://github.com/FasterXML/jackson>Jackson-ом</a>:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=java><span class=kd>public</span> <span class=nc>String</span> <span class=nf>renderToJson</span><span class=o>(</span><span class=nc>Object</span> <span class=n>dto</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>objectMapper</span><span class=o>.</span><span class=na>writeValueAsString</span><span class=o>(</span><span class=n>dto</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=nc>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=nf>AssertionError</span><span class=o>(</span><span class=s>&#34;Unexpected IOException converting object to json&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span></code></pre></div><p>И мне это глаз резало - я генерирую строку в памяти, какой нафик IO???
Но задуматься времени не было.</p><p>А тут за чтением <a href=https://softwareengineering.stackexchange.com/questions/147059/the-modern-way-to-perform-error-handling>The modern way to perform error handling</a> из глубин подсознания внезапно всплыл ответ:)
И знаете что я вам скажу?
Это всё в тот же топик смеси политик/алгоритмов и эффектов и проблем вызываемых этим.</p><p>Если заглянуть в кишочки <code>writeValueAsString</code>, то этот <a href=https://telegra.ph/CHistye-i-gryaznye-funkcii-ehffekty-i-obrabotka-signalov-sajdehffekty-chistye-funkcii-01-12>чистый</a> по сути метод является обёрткой вокруг <code>_writeValueAndClose(JsonGenerator g, Object value)</code>.
g - это обёртка вокруг <code>java.io.Writer</code>.
Writer выбрасывает <code>java.io.IOException</code>.
И привет IOException при генерации строки в памяти.</p><p>Эта проблема обусловлена смешанием в одной функции (_writeValueAndClose) политики (правил формирования json-а по ява-объекту) и эффекта (записи результата формирования в абстрактный приёмник).</p><p>Для того чтобы этот код сделать <a href=https://github.com/d-r-q/developing-ergonomic-code/blob/master/book-rus/developing-ergonomic-code.adoc>эргономичиным</a>, надо растащить две эти "штуки":</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=k>fun</span> <span class=nf>transform</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nc>Any</span><span class=p>):</span> <span class=nc>Sequence</span><span class=p>&lt;</span><span class=nc>Char</span><span class=p>&gt;</span> <span class=p>=</span>
  <span class=c1>// весь этот адовый, но чистый алгоритм по ренедренду json-а</span>

<span class=k>fun</span> <span class=nf>writeValueAsString</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nc>Any</span><span class=p>)</span> <span class=p>=</span> <span class=nf>transform</span><span class=p>(</span><span class=n>value</span><span class=p>).</span><span class=nf>joinToString</span><span class=p>()</span>

<span class=nd>@Throws</span><span class=p>(</span><span class=nc>IOException</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
<span class=k>fun</span> <span class=nf>writeValue</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nc>Any</span><span class=p>,</span> <span class=n>w</span><span class=p>:</span> <span class=nc>Writer</span><span class=p>)</span> <span class=p>=</span> <span class=nf>transform</span><span class=p>(</span><span class=n>value</span><span class=p>).</span><span class=nf>forEach</span> <span class=p>{</span> <span class=n>w</span><span class=p>.</span><span class=nf>append</span><span class=p>(</span><span class=n>it</span><span class=p>)</span> <span class=p>}</span></code></pre></div><p>Это всё тот же <a href=https://github.com/d-r-q/developing-ergonomic-code/blob/master/book-rus/developing-ergonomic-code.adoc#%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D1%8E%D0%B7-%D0%BA%D0%B5%D0%B9%D1%81%D0%B0>эргономичный</a>
(ака <a href=https://fsharpforfunandprofit.com/rop/>ROP</a>, ака <a href="https://www.youtube.com/watch?v=yTkzNHF6rMs">Functional Core/Imperative Shell</a>) паттерн (до которого я ещё не дошёл в этом канале):</p><div class="olist arabic"><ol class=arabic><li>отдельно чистая бизнес-логика (transform);</li><li>отдельно эффективный порт (Writer);</li><li>и юзкейс/воркфлов (writeValueAsString, writeValue) их связывающий.</li></ol></div><p>Разделение логики и эффектов даёт юзерам кубики из которых каждый юзер может собрать нужный именно ему юз кейс.
А юз кейсы которые кажутся наиболее востребованными можно сразу включить в поставку.</p><p>Я не то чтобы пинаю авторов Jackson-а, и вижу как минимум три причины сделать так как есть:</p><div class="olist arabic"><ol class=arabic><li>Я не уверен, что вариант с сиквенсами можно сделать таким же быстрым как и запись сразу в выходной поток, и для них это критично;</li><li>Скорее всего, когда они писали этот код, ещё не было моды на функциональщину и в яве просто не было <a href=https://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html>Stream API</a>;</li><li>Сделать сразу хороший дизайн сложно, а если ты автор популярной библиотеки и уважаешь своих юзеров, то твои "ошибки молодости" с тобой на вечно, из-за обратной совместимости.</li></ol></div><p>Но мы, вооружённые знаниями об эргономичном подходе, опытом чужих ошибок и либой сиквенсов, можем сразу проектировать своё приложение эргономичным. Если требования по перформансу позволяют:)</p><p>Этот пост написано преимущественно в контексте разработки библиотек (Jackson), но применим и к разработке прикладных программ.
Ядро/домен системы <s>следует</s> можно рассматривать как стандартную библиотеку, которой пользуется ваша прикладная программа.
Основное преимущество такого подхода заключается в том, что хорошую библиотеку могут использовать много приложений, а у вас их должно быть как минимум два - собственно боевое приложение и тесты.
Но вообще "Модуль домена как библиотека" - это тема отдельного поста, поэтому подробности как-нить в другой раз:) <span class=logo><img src=/images/logo.svg alt=logo></span></p><hr><p>P.s. возможно вы скажете, что ленивый Sequence != энергичный Writer и его писать <s>сложнее</s> непривычнее, но благодоря корутинам даже это не так:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=kd>val</span> <span class=py>obj</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
<span class=kd>val</span> <span class=py>seq</span> <span class=p>=</span> <span class=n>sequence</span><span class=p>&lt;</span><span class=nc>Char</span><span class=p>&gt;</span> <span class=p>{</span>
    <span class=k>yield</span><span class=p>(</span><span class=sc>&#39;{&#39;</span><span class=p>)</span>
    <span class=n>obj</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>memberProperties</span><span class=p>.</span><span class=nf>forEach</span> <span class=p>{</span>
        <span class=nf>yieldAll</span><span class=p>(</span><span class=s>&#34;\&#34;${it.name}\&#34;: ${it.call()}&#34;</span><span class=p>.</span><span class=nf>asSequence</span><span class=p>())</span>
    <span class=p>}</span>
    <span class=k>yield</span><span class=p>(</span><span class=sc>&#39;}&#39;</span><span class=p>)</span>
<span class=p>}</span></code></pre></div></article><br></section></div></main><script src=/js/app.js></script></body></html>