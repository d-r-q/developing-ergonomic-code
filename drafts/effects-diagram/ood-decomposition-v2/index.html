<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Диаграмма эффектов: объектно-ориентированная декомпозиция - Алексей Жидков"><meta property="og:description" content="Этот пост является третьей частью из серии постов о диаграмме эффектов, в котором я расскажу как использовать диаграмму эффектов для объектно-ориентированной декомпозиции системы"><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/drafts/effects-diagram/ood-decomposition-v2/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/drafts/effects-diagram/ood-decomposition-v2/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/drafts/effects-diagram/ood-decomposition-v2/><title>Диаграмма эффектов: объектно-ориентированная декомпозиция - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/drafts/effects-diagram/ood-decomposition-v2/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/ergo-approach/landing>Эргономичный подход</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/effects-diagram/landing>Диаграмма Эффектов</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Диаграмма эффектов: объектно-ориентированная декомпозиция</h1></header><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Следить за обновлениями блога можно в моём канале: <a href=https://t.me/ergonomic_code>Эргономичный код</a></p></aside><section class="doc-section level-1"><h2 id=_введение><a class=link href=#_введение>Введение</a></h2><p>Года три назад у меня был "разговор у кулера" с коллегой, в котором я критиковал декомпозицию по слоям.
В ответ на это коллега сказал - "Ну это всё понятно. Но по другому-то как?".
На тот момент мне было нечего сказать, кроме общих слов вроде: "эээ…​ нууу…​ это же и есть работа архитектора, надо смотреть на каждый конкретный случай".</p><p>Поиск максимально понятного ответа на этот вопрос стал моей идеей фикс.
Спустя два года я его нашёл: "Систему надо декомпозировать на модули, инкапсулирующие эффекты".
Как это делать?
Это я раскладывал по полочкам ещё год.
И в результате у меня родилась ясная методика декомпозиции на базе эффектов.</p></section><section class="doc-section level-1"><h2 id=_декомпозиция_на_базе_эффектов_или_объектно_ориентированная_декомпозиция><a class=link href=#_декомпозиция_на_базе_эффектов_или_объектно_ориентированная_декомпозиция>Декомпозиция на базе эффектов или объектно-ориентированная декомпозиция</a></h2><p>(<mark>todo: === почему всё-таки ОО-декомпозиция?</mark>)</p><section class="doc-section level-2"><h3 id=_терминология><a class=link href=#_терминология>Терминология</a></h3><p>Для начала мне необходимо определить терминологию, которой я буду пользоваться дальше по тексту всего поста.
В частности мне нужны три ключевых понятия - эффект, ресурс и операция.
Они все подробно описаны в концептуальной модели диаграммы эффектов (<mark>todo: линка</mark>), а здесь я приведу лишь краткие определения:</p><div class=ulist><ul><li><strong>эффект</strong> - это акт взаимодействия (чтения или записи) программы с глобальным состоянием.
Звучит, возможно, непонятно, но каждый программист ежедневно работает с эффектами.
Присваивание глобальной переменной, запись в файл, обращение к ресурсу REST API внешней системы, считывание текущего времени, обновление строки в реляционной БД - это всё эффекты;</li><li><strong>ресурс</strong> - это именованная часть глобального состояния, с которой взаимодействует программа.
Статическая переменная, файл, ресурс REST API внешней системы, текущее время, таблица реляционной БД - это всё примеры ресурсов.</li><li><strong>операция</strong> - это атомарня функция, доступная пользователям (людям или машинам) системы.
Сейчас операции информационных систем как правило определяются в виде методов REST API.</li></ul></div><p>Все эти элементы имеют непосредственное отражение в исходном коде системы.
Ресурсы - это классы инкапслуриющие части глобального состояния - репозитории, клиенты вшених систем и т.п.
Операции - это методы классов слоя сервисов приложения.
Эффекты - это вызовы методами операций методов классов ресурсов.</p><p>Соответсвенно декомпозиция на базе эффектов - это такая декомпозиция, которая помещает классы сервисов приложения и классы нужных им ресурсов в один модуль.</p></section><section class="doc-section level-2"><h3 id=_зачем_брать_эффекты_в_основу_декомпозиции><a class=link href=#_зачем_брать_эффекты_в_основу_декомпозиции>Зачем брать эффекты в основу декомпозиции?</a></h3><p>В чём заключаются недостатаки других распространённых подходов к декомпозиции систем я подробно описал в посте (<mark>todo: линка</mark>).
Здесь же приведу лишь суть - другие подходы либо сложны в изучении и исполнении, либо дают плохие результаты с точки зрения поддерживаемости програм.
Соответсвенно, в противовес им, декомпозиция на базе эффектов проста в изучении и исполнении, и всё равно даёт хорошие результаты.</p><p>Правомерность этих утверждений подтверждается серией научных статей (<mark>todo: линка</mark>), в которой авторы приводят немного другой по меахнике исполнения, но такой же по сути подход к декомпозиции.
Кульминацией этой серии является статья, в которой авторы сравинвают декомпозицию на базе эффектов с декомпозицией по Предметно-Ориентированному проектированию (DDD) и приходят к выводу, что декомпозиция на базе эффектов даёт результат, аналогичный DDD но существенно быстрее ("Часы", вместо "дней").</p></section><section class="doc-section level-2"><h3 id=_методика_выполнения_декомпозиции_на_базе_эффектов><a class=link href=#_методика_выполнения_декомпозиции_на_базе_эффектов>Методика выполнения декомпозиции на базе эффектов</a></h3><p>Декомозиция на базе эффектов состоит из двух больших шагов:</p><div class="olist arabic"><ol class=arabic><li>Построение диаграммы эффектов на основе требований;</li><li>Выполнение кластеризации диаграммы.
Такие кластеры я в дальнейшем буду называть модулями.</li></ol></div><p>Первый шаг подробно описан в посте (<mark>todo: линка</mark>), в конце которого мы получили следующую диаграмму эффектов проекта TSP:</p><div class=image-block><img src=/drafts/effects-diagram/images/tsp/true-story-effects-orig.svg alt="true story effects orig"></div><p>В этом же посте мы рассмотрим второй шаг.</p><p>Для того чтобы кластеризация стала основой системы с высокой степенью поддерживаемости, необходимо, чтобы сами кластеры соответствовали следующим критериям:</p><div class=ulist><ul><li>В связях между кластерами не должно быть циклов.
Для этого не должно быть двух кластеров, операции которых взаимодействуют с ресурсами друг друга;</li><li>Количество красных стрелок, пересекающих границы кластера, должно быть минимальным.
Вполне достижимый идеал - отсутствие таких стрелок;</li><li><p>Количество синих стрелок, пересекающих границы кластера должно быть минимальным.</p><p>С этим критерием надо быть осторожным, так как полное отсутствие эффектов пересекающих границы модуля может быть признаком помещения на одну диаграмму нескольких несвязанных систем или патологической расцпленности системы.
В первом случае диаграмму необходимо разбить на несколько.
А во втором - скрытую сцепленность через события лучше превратить в явную сцепленность через эффекты.</p></li><li>Каждому кластеру можно дать чёткое и лаконичное название, отражающее входящие в него элементы.</li></ul></div><p>Кластеризация удволетворяющая этим критериям, станет базой для модулей, которые:</p><div class=ulist><ul><li>имеют минимально необходимую <a href=https://www.chegg.com/learn/computer-science/computer-software/common-coupling>сцепленность через общее окружение</a>;</li><li>высокую <a href=https://ieeexplore.ieee.org/document/731241>объектно-ориентированную связанность</a>;</li><li>низкую объектно-ориентированную сцепленность (та же статья).</li></ul></div><p>В результате модули будут обладать локальностью рассуждений и изменений.
Локальность рассуждений позволит понять что делает модуль или каковы будут последствия изменения в его поведении, глядя только на код этого модуля.
Локальность изменений [в коде] позволит большинство изменений в требованиях ограничить рамками одного модуля.</p><p>Если эти критерии держать в голове (или подкорке), то кластеризацию можно выполнить неявно процессе построения диаграммы и для небольшой диаграммы она будет видна невооружённым глазом:</p><div class=image-block><img src=/drafts/effects-diagram/images/tsp/tsp-decomposition-intuitive-anim.drawio.png alt="tsp decomposition intuitive anim.drawio"></div><p>Здесь и далее чёрными прямоугольниками обозначаются границы кластеров.</p><p>Если по каким-то причинам (например, слишком большая или запутанная диаграмма) кластеризация не видна сразу или видимая кластеризация не удволетворяет критериям качества, то на помощь приходит алгоритм кластеризации диаграммы на базе эффектов.</p></section><section class="doc-section level-2"><h3 id=_алгоритм_кластеризации_на_базе_эффектов><a class=link href=#_алгоритм_кластеризации_на_базе_эффектов>Алгоритм кластеризации на базе эффектов</a></h3><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=k>fun</span> <span class=nf>clusterize</span><span class=p>(</span><span class=n>diagram</span><span class=p>:</span> <span class=nc>Diagram</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=py>proceed</span> <span class=p>=</span> <span class=k>true</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>diagram</span><span class=p>.</span><span class=nf>hasFreeElements</span><span class=p>()</span> <span class=p>&amp;&amp;</span> <span class=n>proceed</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>proceed</span> <span class=p>=</span> <span class=k>false</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>r</span> <span class=k>in</span> <span class=n>diagram</span><span class=p>.</span><span class=n>freeResources</span><span class=p>)</span> <span class=p>{</span>
            <span class=kd>val</span> <span class=py>tightlyCoupledOperations</span> <span class=p>=</span> <span class=n>r</span><span class=p>.</span><span class=n>operations</span>
                <span class=p>.</span><span class=nf>filter</span> <span class=p>{</span> <span class=n>o</span> <span class=p>-&gt;</span> <span class=n>o</span><span class=p>.</span><span class=n>resources</span><span class=p>.</span><span class=n>size</span> <span class=p>==</span> <span class=mi>1</span> <span class=p>||</span>
                               <span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=n>writtenResources</span><span class=p>.</span><span class=n>size</span> <span class=p>==</span> <span class=mi>1</span> <span class=p>&amp;&amp;</span> <span class=n>o</span><span class=p>.</span><span class=n>writtenResources</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>==</span> <span class=n>r</span><span class=p>)</span> <span class=p>||</span>
                               <span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=n>isReadOnly</span> <span class=p>&amp;&amp;</span> <span class=nc>God</span><span class=p>.</span><span class=nf>isPrimaryResource</span><span class=p>(</span><span class=n>o</span><span class=p>,</span> <span class=n>r</span><span class=p>))</span> <span class=p>}</span>
            <span class=n>diagram</span><span class=p>.</span><span class=nf>makeCluster</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>tightlyCoupledOperations</span><span class=p>)</span>
            <span class=n>proceed</span> <span class=p>=</span> <span class=n>tightlyCoupledOperations</span><span class=p>.</span><span class=nf>isNotEmpty</span><span class=p>()</span>
        <span class=p>}</span>

        <span class=k>for</span> <span class=p>(</span><span class=n>e</span> <span class=k>in</span> <span class=n>diagram</span><span class=p>.</span><span class=n>freeElements</span><span class=p>)</span> <span class=p>{</span>
            <span class=kd>val</span> <span class=py>adjaсentClusters</span> <span class=p>=</span> <span class=n>e</span><span class=p>.</span><span class=n>elements</span><span class=p>.</span><span class=nf>map</span> <span class=p>{</span> <span class=n>it</span><span class=p>.</span><span class=n>cluster</span> <span class=p>}.</span><span class=nf>toSet</span><span class=p>()</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>adjecentClusters</span><span class=p>.</span><span class=n>size</span> <span class=p>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>diagram</span><span class=p>.</span><span class=nf>extendCluster</span><span class=p>(</span> <span class=n>adjacentClusters</span><span class=p>.</span><span class=nf>first</span><span class=p>(),</span> <span class=n>e</span><span class=p>)</span>
                <span class=n>proceed</span> <span class=p>=</span> <span class=k>true</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>for</span> <span class=p>(</span><span class=n>r</span> <span class=k>in</span> <span class=n>diagram</span><span class=p>.</span><span class=n>freeResources</span><span class=p>)</span> <span class=p>{</span>
            <span class=kd>val</span> <span class=py>possiblePairs</span> <span class=p>=</span> <span class=n>r</span><span class=p>.</span><span class=n>operations</span><span class=p>.</span><span class=nf>flatMap</span> <span class=p>{</span> <span class=n>it</span><span class=p>.</span><span class=n>resources</span> <span class=p>}</span>
            <span class=kd>val</span> <span class=py>bestMatch</span> <span class=p>=</span> <span class=nc>God</span><span class=p>.</span><span class=nf>findBestMatch</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>possiblePairs</span><span class=p>)</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>bestMatch</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>diagram</span><span class=p>.</span><span class=nf>aggregate</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>bestMatch</span><span class=p>)</span>
                <span class=n>proceed</span> <span class=p>=</span> <span class=k>true</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>diagram</span><span class=p>.</span><span class=n>hasFreeElements</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>diagram</span><span class=p>.</span><span class=nf>finalyzeClusterization</span><span class=p>()</span>
    <span class=p>}</span>
    <span class=n>diagram</span><span class=p>.</span><span class=nf>nameClusters</span><span class=p>()</span>
    <span class=n>diagram</span><span class=p>.</span><span class=nf>hideSubmodules</span><span class=p>()</span>
    <span class=n>diagram</span><span class=p>.</span><span class=nf>groupModules</span><span class=p>()</span>
<span class=p>}</span></code></pre></div><p>Алгоритм первичной кластеризации итеративный и каждая итерация состоит из трёх этапов:</p><div class="olist arabic"><ol class=arabic><li>Генерация кластеров</li><li>Расширение кластеров</li><li>Агрегация ресурсов</li></ol></div><p>Генерация кластеров заключается в том, чтобы перебрать все некластеризаванные ресурсы и кластеризовать их с операциями, которые:</p><div class="olist arabic"><ol class=arabic><li>Связаны только с этим ресурсом</li><li>Связаны с этим ресурсом своим единственным эффектом записи</li><li>Являются операциями чтения, для которых данных ресурс является первичным.
Определение первичного ресурса (и вообще его наличия) остаётся на усмотрение исполнителя.</li></ol></div><p>Расширене кластеров заключается в том, чтобы перебрать все некластеризованные элементы, связанные только с c элементами внутри одного кластера и добавить их в этот кластер.</p><p>После этого переходим к этапу агрегации ресурсов, который заключается в том, чтобы оставшиеся не кластеризованные ресурсы сгруппировать между собой или с кластеризованными ресурсами.
Строго говоря, на этапе агрегации надо перебрать все возможные попарные соединения и выбрать из них "наилучшие".
Однако на практике "наилучшие" пары как правило имеют общую операцию, поэтому эмпирический алгоритм агрегации выглядит так:</p><div class="olist arabic"><ol class=arabic><li>Для каждого некластеризовнного ресурса, выбрать ресурсы, с которыми у него есть общая операция</li><li>Если в списке есть "разумная" пара данному ресурсу - сгруппировать их.
Универсального и формализованного критерия разумности я пока что не нашёл, поэтому это решение остаётся за исполнителем.</li></ol></div><p>Далее сгруппированные ресурсы рассматриваются как единое целое, в частности все эффекты связывающие любой из ресурсов этой группы с одной и той же операцией считаются одним эффектом.
Если операцию связывают с группой и эффекты чтения и эффекты записи, то считается что операция связана с группой эффектом записи.</p><p>После агрегации ресурсов снова возвращаемся к этапу генерации кластеров.
Если этапы генерации и расширения кластеров не привели к уменьшению количества некластеризованных элементов, то, теоретически, этап агрегации можно снова повторить и продолжать это делать до включения всех оставшихся ресурсов в одну группу.
Однако практически уже на второй последовательной итерации агрегации (когда одина группа некластеризованных ресурсов содержит в себе три базовых) пора становиться на стороже и внимательно смотреть на получающиеся группы ресурсов и связанные с ними и операции и, возможно, вернуться к этапу проектирования самих операций и ресурсов.</p><p>Третью итерацию (агрегацию 4ёх ресурсов), на мой взгляд стоит выполнять просто на всякий случай, но сам факт необходимости в ней говорит либо о серьёзных ошибках в дизайне операций и агрегатов, либо о том, что декомпозиция на базе эффектов не подходит для вашей задачи.</p><p>В результате применения этого алгоритма, вы получите либо полную, либо частичную первичную декомпозицию.
Но в любом случае эта декомпозиция первичная и её надо проверить на соответствие здравому смыслу и, при необходимости - доработать.
И тут я вынужден перейти к общим словам и рекомендациям, потому что здесь приходится работать с семантикой и особенностями конкретной предметной области.</p><p>Если алгоритм породил частичную декомпозицию, то её придётся завершать вручную.
Очевидным образом, на этом этапе останутся некластеризованными только те элементы, которые связаны с двумя и более кластерами.
И тут для каждого элемента остаётся есть несколько вариантов:</p><div class="olist arabic"><ol class=arabic><li>Для некластеризованных операций записи в первую очередь стоит рассмотреть вариант расцепки операции через очередь сообщений.</li><li>Если с одним из кластеров элемент связан большим количеством связей или эти связи кажутся "сильнее" - его можно внести в тот кластер, с которым он сильнее связан.
В случае операции, тут стоит принять во внимание её клиента - если с одним из кластеров у неё общий клиент, то связь с этим кластером кажется сильнее;</li><li>Если элемент выглядит связанным со всеми кластерами в равной степени - его можно поместить в собственный кластер.
В этот же кластер, возможно, можно будет добавить другие элементы связанные с теми же кластерами.</li><li>Если кластеры, связанные элементом имеют высокую функциональную связанность - их можно объединить в один кластер.</li><li>Если и первый и второй вариант выглядят странно или нелогично - возможно стоит вернуться к дизайну операций и ресурсов.</li><li>Ещё вариант - пересмотреть состав существующих кластеров, возможно тогда получится получить логичную картинку.</li></ol></div><p>После получения полной кластеризации, каждому кластеру необходимо дать имя, отражающее его содержание.
В случае хорошей декомпозиции - это не составит труда.
Если же определить имя какого-то кластера не получается, то необходимо рассмотреть его внимательнее.
Достаточно часто такие проблемы решаются с помощью разделения проблемного кластера на два более мелких и сфокусированных.
Но поиск разумного имени кластера может привести и к редизайну ресурсов и операций.</p><p>После того, как каждому кластеру дано разумное имя полезно проделать ещё одно упражнение - нарисовать граф кластеров.
Такая визуализация помогает увидеть "лес за деревьями" и оценить "разумность" уже самого леса.</p><p>Наконец, последний шаг, особенно если получилось больше 5 кластеров - найти подмодули и функционально схожие модули.
Подмодуль - это модуль, обеспечивающий работу одного базового модуля.
В этом случае кластер подмодуля необходимо поместить в кластер модуля.
Как понять, что один модуль обеспечивает работу другого?
К сожалению у меня только общие слова.
Посмотри в сторону уровней абстракции и политик/механизмов.</p><p>Функционально схожие модули - это модули, выполняющие разными способами одну и ту же функциональность, либо выполняющие разные подфункции одной общей функции.
Такие модули надо объединить в общий кластер.
Этому кластеру так же надо дать имя и если это вызывает затруднения, то от объединения лучше отказаться.</p><p>Ещё одно полезное упражнение - провести топологическую сортировку этого.
Это позволит вам определить стабильность модулей (отношение количества входящих зависимостей к количеству исходящих) и убедиться, что техническая стабильность модулей согласована со стабильностью частей предметной области.
(<mark>todo: для этого не надо выполнять сортировку</mark>)</p><p>Всё теперь можно создавать структуру директорий, соответствующую структуре кластеров, в каждой директории создавать по классу сервиса со всеми операциями кластера и по классу репозитрия/клиента/топика для каждого ресурса кластера.
Так же, в целях снижения сцепленности, в сервисы модуля надо будет добавить по методу на каждую стрелку, входящую в кластер.</p><hr><p>Алгоритм первичной кластеризации итеративный и каждая итерация состоит из двух этапов:</p><div class="olist arabic"><ol class=arabic><li>Сбор "низко висящих фруктов"</li><li>Агрегация ресурсов</li></ol></div><p>Сбор низко висящих фруктов заключается в том, чтобы перебрать все некластеризаванные ресурсы и кластеризовать их с операциями, которые:</p><div class="olist arabic"><ol class=arabic><li>Связаны только с этим ресурсом</li><li>Связаны с этим ресурсом своим единственным эффектом записи</li><li>Являются операциями чтения, для которых данных ресурс является первичным</li></ol></div><p>Сбор низко висящих фруктов операций заключается в том, чтобы внести операции, которые всеми эффектами или хотя бы всеми эффектами записи связаны с ресурсами только одного кластера внести в этот кластер.</p><p>Но ресурсов, для которых есть операции удовлетворяющие этим критериям может не найтись - в этом случае надо переходить к агрегации ресурсов.
Агрегация ресурсов заключается в том, чтобы оставшиеся не кластеризованные ресурсы внести в один из существующих кластеров или объединить в пары между собой.
Строго говоря, на этапе агрегации надо перебрать все возможные попарные соединения и выбрать из них "наилучшие".
Но на практике, разумные пары видны на диаграмме невооружённым глазом и можно просто взять их.
После агрегации снова надо выполнить первый этап алгоритма</p><p>Если после агрегации ресурсов, первый этап снова не породил новых кластеров, то в принципе, этап агрегации можно повторить, и теоретически его можно повторять до победного.
Однако, уже на второй итерации агрегации (когда один агрегированных ресурс содержит в себе три базовых) пора становиться на стороже и внимательно смотреть на получающиеся агрегированые ресурсы и связанные с ними и операции и, возможно, вернуться к этапу проектирования самих операций и ресурсов.</p><p>Третью итерацию (агрегацию 4ёх ресурсов), но мой взгляд стоит выполнять просто на всякий случай, но сам факт необходимости в ней говорит либо о серьёзных ошибках в дизайне операций и агрегатов, либо о том, что декомпозиция на базе эффектов не подходит для вашей задачи.</p><p>После выполнения первичной кластеризации, у вас скорее всего останутся некластеризованными некоторые только считываемые ресурсы и/или операции на чтение, которые связаны с двумя и более кластерами.
С ними можно поступить двумя очевидными способами и одним не очевидным способом.
Очевидные способы - внести в один из кластеров или поместить в собственный кластер.
Выбрать один из них вам помогут две классических качественных характеристики связей - функциональная связанность и сцепленность.
Если вы оцениваете, что элемент функционально связан или сцеплен с одним из кластеров сильнее, чем с остальными - поместите элемент в этот кластер.
В противном случае - создайте кластер вокруг этого элемента.
Но тут, к сожалению, мы заходим в "терра аморфиус" - я не знаю алгоритма определения связанности и сцепленности, кроме как на глаз.
И если со сцепленность ещё хоть как-то можно опереться на частоту обращения и объём передаваемых данных данных, то связанность определяется просто на глаз.</p><p>Ещё более сложным для описания является неочевидный способ - ещё раз задуматься о дизайне ресурсов и операций.
По своему опыту я могу сказать, что "повисшие" могут указывать на ошибки в проектировании ресурсов.
Тут, к сожалению, вы уже окончательно сами по себе и я не могу дать универсальной инструкции, как именно надо задумываться о дизайне.
Пока что, по крайней мере.
Зато я могу показать пример.</p><hr><p>Алгоритм выполняется над диаграммой эффектов (в краткой нотации без событий) и фактически состоит из двух действий - добавить новый прямоугльник (границы кластера) на диагрмму и внести элемент диаграммы (операцию или ресурс) внуть существующего прямоугольника.
Алгоритм проще всего описать с помощью блок-схемы:</p><div class=image-block><img src=/drafts/effects-diagram/images/decomposition-algorithm.drawio.svg alt="decomposition algorithm.drawio"></div><p>и примера его применения к специально запутанной диаграмме эффектов TSP:</p><div class=image-block><img src=/drafts/effects-diagram/images/tsp/tsp-decomposition-algo-anim.drawio.png alt="tsp decomposition algo anim.drawio"></div><p>Давайте расмотрим шаги, из которых состоит кластеризация, визуализированная в анимации.</p><p><strong>Шаг 1</strong>: выбираем красную любую стрелку.
Для русского человека логично взять самую верхнюю левую стрелку - "Отправить фид в 2Гис".
Вытаскиваем стрелку с операцией и ресурсом из "мяса" и с радостью обнаруживаем, что за ними больше ничего не тянется и мы, похоже, сразу же нашли первый модуль - обводим его прямоугольником.</p><p><strong>Шаг 2</strong>: выбираем следующую красную стрелку.
Пусть это будет "Сохранить изображение".
Вытягиваем её (вместе с операцией и ресурсом) в сторонку и обводим.
На этот раз у нас много стрелок ушло за границу</p><p><strong>Шаг 3</strong>: подтягиваем внутрь модуля операции, которые зависят только от ресурса "Изображения".</p><p><strong>Шаг 4</strong>: выбираем следующую стрелку - пусть это будет "Опубликовать новый фид".</p><p><strong>Шаг 5</strong>: операций, связанных с ресурсом темы "Сгенерирован новый фид" больше нет, зато есть ресурсы, связанные с операцией "Перегенерировать фид" - подтягиваем их внутрь модуля.</p><p><strong>Шаг 6</strong>: выбираем последнюю красную стрелку - "Сохранить фид Яндекса".
Обводим её.
И сразу подтягиваем последний оставшийся ресурс.</p><p><strong>Шаг 7</strong>: даём имена прямоугольникам (в порядке появления).
"Интеграция с 2Гис", "Изображения", "Генерация фида", "Интеграция с Яндекс.Карты".</p><p>Тут, на мой взгляд, стоит остановиться и обратить внимание, что мы получили вполне разумную декомпозицию.
И это поразительно, потому что декомпозицию мы выполняли полностью механически оперируя только цветами стрелок и прямоугольников и их связями и пересечениями, абсолютно не учитывая семантику, скрывающуюся за этими геометрическими фигурами.
При желании, я уверен, этот алгоритм можно закодировать и выполнять такую декомпозицию полностью автоматически.
Но у такого подхода есть свои ограничения, и получить (в общем случае) идеальную декомпозицию предметной области, игнорируя саму предметную область невозможно.
Поэтому мы переходим к двум последним шагам, которые требуют понимания семантики и, соответвтенно, которые может выполнить только человек.</p><p><strong>Шаг 8</strong>: выполняем обобщение.
На мой взгляд наглядность декомпозиции предметной области повысится, если мы скроем модули "Интеграция с 2Гис" и "Интеграция с Яндекс.Карты" в более абстрактном модуле "Интеграция с геосервисами".
Для этого мы добавим ещё один прямоугольник вокруг соответствующих модулей.</p><p><strong>Шаг 9</strong>: применяем здравый смысл.
Внимательно смотрим на каждый модуль.
Что находится внутри?
Это согласуется с именем модуля?
От каких модулей он зависит?
Это разумно?
Сейчас на мой взгляд к самой декомпозиции уже не придраться.
Поэтому вместо здравого смысла мы применим творческое начало и немного "причешем" диаграмму, чтобы она смотрелась "аккуратно" на наш субъективный взгляд.</p><p>Но как я уже писал, кластеризация диаграммы эффектов проекта TSP была видна невооружённым глазом, поэтому давайте дополнительно рассмотрим кластеризацию с помощью этого алгоритма диаграмму эффектов проекта Кэмп.</p></section></section><section class="doc-section level-1"><h2 id=_декомпозиция_диаграммы_эффектов_проекта_кэмп><a class=link href=#_декомпозиция_диаграммы_эффектов_проекта_кэмп>Декомпозиция диаграммы эффектов проекта "Кэмп"</a></h2><p><strong>Шаг 1</strong>:</p></section><section class="doc-section level-1"><h2 id=_декомпозиция_диаграммы_эффектов_проекта_кэмп_2><a class=link href=#_декомпозиция_диаграммы_эффектов_проекта_кэмп_2>Декомпозиция диаграммы эффектов проекта "Кэмп"</a></h2><p>Но как я уже говорил, проект TSP вполне можно было декомпозировать и "на глаз", поэтому давайте дополнительно рассмотрим ещё декомпозицию по алгоритму немного упрощённой диаграммы эффектов проекта Кэмп.
Для того, чтобы нивелировать "предвзятость" диаграммы "разложенной" вручную, будем декомпозировать диаграмму "разложенную" graphviz-ом.</p><p>Для этого я перевёл руками <a href=../images/camp-effects.drawio.svg>исходную диаграмму</a> в <a href=../images/camp-neato.graphviz download>graphbiz-файл</a>, а затем сконвертировал его в svg-файл <a href=https://graphviz.org/docs/outputs/svg/>стандартными средствами</a>:</p><div class=image-block><img src=/drafts/effects-diagram/images/camp-neato.svg alt="camp neato"></div><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>После перевода диаграммы в формат SVG, декомпозицию можно выполнять в любом редакторе векторной графики с поддержкой этого формата, например <a href=https://inkscape.org/>Inkscape</a>.</p></aside><p>Как видно, визуализация состоит из двух несвязанных графов - меньший граф, отражающий функциональность уведомлений, и больший граф отражающий основную функциональность системы.
В оригинальной диаграмме эти подграфы были связаны событием публикации сообщения о модерации точки, но для целей визуализации стрелки событий удаляются с диаграммы.</p><p>Так же для того чтобы визуализация стала более компактной и лучше смотрелись в на странице, я выделил несвязанные графы оригинальной визуализации в отдельные изображения и немного подправил раскладку графа основной функциональности:</p><div class=image-block><img src=/drafts/effects-diagram/images/camp-neato-main.svg alt="camp neato main"></div><div class=image-block><img src=/drafts/effects-diagram/images/camp-neato-push.svg alt="camp neato push"></div><p>Теперь давайте прогоним обе визуализации через алгоритм и начнём с графа основной функциональности Кэмпа.</p></section><section class="doc-section level-1"><h2 id=_приложение_1_использование_graphviz_для_постороения_диаграммы_эффектов><a class=link href=#_приложение_1_использование_graphviz_для_постороения_диаграммы_эффектов>Приложение 1. Использование graphviz для постороения диаграммы эффектов</a></h2><section class="doc-section level-2"><h3 id=_визуализация_диаграммы_с_помощью_graphviz_и_интуитивная_декомпозиция><a class=link href=#_визуализация_диаграммы_с_помощью_graphviz_и_интуитивная_декомпозиция>Визуализация диаграммы с помощью graphviz и интуитивная декомпозиция</a></h3><p>Авторы функциональной декомпозиции предлагают использовать для визуализации графа операций и ресурсов graphviz с алгоритмом раскладки NEATO.
Например, граф, аналогичный диаграмме эффектов проект TSP может быть закодирован так:</p><p>(<mark>todo: расписать - как указать neato, как указать двойной вес эффектов записи, как указать цвета узлов и связей</mark>)</p><div class=listing-block><pre class="rouge highlight"><code data-lang=dot><span class=k>strict</span> <span class=k>digraph</span>  <span class=p>{</span>
    <span class=n>overlap</span> <span class=p>=</span> <span class=nv>scale</span>
    <span class=n>sep</span> <span class=p>=</span> <span class=mf>0.5</span>

    <span class=s2>&#34;Отправить фид в 2Гис&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Обновить фид для Яндекса&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Выдать фид Яндекса&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>

    <span class=s2>&#34;Загрузить изображение&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Скачать изображение&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Выдать список изображений организации&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Удалить изображение&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>

    <span class=s2>&#34;Перегенерировать фид&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#b6d7f0&#34;</span><span class=o>]</span>

    <span class=s2>&#34;Интеграция с 2Гис&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#85bbf0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Фид Яндекса&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#85bbf0&#34;</span><span class=o>]</span>

    <span class=s2>&#34;Изображения&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#85bbf0&#34;</span><span class=o>]</span>

    <span class=s2>&#34;Организации&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#85bbf0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Дополнительная информация&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#85bbf0&#34;</span><span class=o>]</span>
    <span class=s2>&#34;Тема Сгенерирован новый фид&#34;</span> <span class=o>[</span><span class=n>shape</span><span class=p>=</span><span class=s2>&#34;rectangle&#34;</span> <span class=n>style</span><span class=p>=</span><span class=s2>&#34;filled&#34;</span> <span class=n>fillcolor</span><span class=p>=</span><span class=s2>&#34;#85bbf0&#34;</span><span class=o>]</span>

    <span class=s2>&#34;Отправить фид в 2Гис&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Интеграция с 2Гис&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#b85450&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>2</span><span class=o>]</span>
    <span class=s2>&#34;Обновить фид для Яндекса&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Фид Яндекса&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#b85450&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>2</span><span class=o>]</span>

    <span class=s2>&#34;Загрузить изображение&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Изображения&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#b85450&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>2</span><span class=o>]</span>
    <span class=s2>&#34;Удалить изображение&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Изображения&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#b85450&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>2</span><span class=o>]</span>

    <span class=s2>&#34;Перегенерировать фид&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Тема Сгенерирован новый фид&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#b85450&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>2</span><span class=o>]</span>

    <span class=s2>&#34;Фид Яндекса&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Выдать фид Яндекса&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#6c8ebf&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>1</span><span class=o>]</span>

    <span class=s2>&#34;Изображения&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Скачать изображение&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#6c8ebf&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>1</span><span class=o>]</span>
    <span class=s2>&#34;Изображения&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Выдать список изображений организации&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#6c8ebf&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>1</span><span class=o>]</span>

    <span class=s2>&#34;Изображения&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Перегенерировать фид&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#6c8ebf&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>1</span><span class=o>]</span>
    <span class=s2>&#34;Организации&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Перегенерировать фид&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#6c8ebf&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>1</span><span class=o>]</span>
    <span class=s2>&#34;Дополнительная информация&#34;</span> <span class=o>-&gt;</span> <span class=s2>&#34;Перегенерировать фид&#34;</span> <span class=o>[</span><span class=n>color</span><span class=p>=</span><span class=s2>&#34;#6c8ebf&#34;</span><span class=p>;</span><span class=n>weight</span><span class=p>=</span><span class=mi>1</span><span class=o>]</span>
<span class=p>}</span></code></pre></div><p>И визуализирован так:</p><div class=image-block><img src=/drafts/effects-diagram/images/tsp/tsp-neato.svg alt="tsp neato"></div><p>В этой визуализации группы, пожалуй, менее очевидны, но тем не менее видны и graphviz невозможно упрекнуть в подгонке результатов.</p><p>Но интуитивная декомпозиция хорошо работает только на простых графах.
На запутанных или достаточно больших графах группы могут быть не очевидны и иногда просто не понятно с какой стороны подойти к графу, чтобы начать выполнять декомопзицию.</p></section></section></article></section></div></main><script src=/js/app.js></script></body></html>