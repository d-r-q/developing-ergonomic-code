<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Кейс: как я превратил легаси-проект в конфетку за полгода - Алексей Жидков"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/drafts/project-e-retro/project-e-part1/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/drafts/project-e-retro/project-e-part1/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/drafts/project-e-retro/project-e-part1/><title>Кейс: как я превратил легаси-проект в конфетку за полгода - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/drafts/project-e-retro/project-e-part1/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/ergo-approach/landing>Эргономичный подход</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/effects-diagram/landing>Диаграмма Эффектов</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Кейс: как я превратил легаси-проект в конфетку за полгода</h1></header><section class="doc-section level-1"><h2 id=_введение><a class=link href=#_введение>Введение</a></h2><p>Недавно мне удалось за шесть месяцев превратить полный боли, багов и сорванных дедлайнов легаси-проект на микросервисной архитектуре в полный фана проект на монолите, в котором мы стабильно попадаем в дедлайны, а существенные баги в коде бэка доходят до команды QA пару раз в квартал.</p><p>Эта эпопея не сильно уступает по объёму "Войне и Миру", поэтому я разбил её на четыре тома:</p><div class="olist arabic"><ol class=arabic><li>Том первый. "Пациент скорее мёртв, чем жив" - описание проекта, история получения разрешения на реинжиниринг и планирование работ</li><li>Том второй. "Доктор сказал в морг, значит в морг" - описание процесса работы, что пошло не по плану и как факапились в проде</li><li>Том третий. "Анатомический атлас конфетки" - детали реализации "конфетки"</li><li>Том четвёртый. "Это наследственное" - описание проблем, вызванных сменой архитектуры и стэка, а также необходимостью параллельной работы со старым бэком</li></ol></div><p>Из этого поста вы узнаете, как не надо делать проекты, в каких случаях есть шанс получить разрешение на реинжиниринг и как эти шансы повысить, а так же способ планирования работ, который сработал в 1 из 1 случаев:)</p></section><section class="doc-section level-1"><h2 id=_проект_э><a class=link href=#_проект_э>Проект Э</a></h2><p>В начале января 2019 года российский производитель медоборудования заказал разработку проекта в аутсорсинговой компании из ближнего зарубежья.
Далее я буду называть этот проект Проектом Э.</p><p>Очень упрощённо проект можно считать медицинским дневником.
Пользователи (пациенты) собирают с помощью устройства заказчика определённые показатели организма, которые сохраняются в БД на бэке.
В дополнение к этому, пользователи могут вносить в систему дополнительную информацию, такую как приём лекарств, пищи, занятия спортом и т.п.
А врачи, по приглашению пациентов, получают доступ к их дневникам.</p><p>Так выглядела диаграмма контекста <a href=https://c4model.com/>модели C4</a> Проекта Э в конце 2019 года (картинка кликабельна):</p><div class=image-block><a class="image bare" href=/drafts/project-e-retro/images/project-e-context.drawio.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/project-e-retro/images/project-e-context.drawio.svg alt="Диаграмма контекста Проекта Э"></a></div><p>Изначальная команда реализовала ~90% проекта к октябрю 2019 года и заказчик занялся сертификацией своего устройства, заморозив разработку.
Сертификация продолжалась до 2022 года и к тому моменту, когда заказчик закончил сертификацию устройства и был готов возобновить работы, подрядчик отказался продолжать работы по проекту.</p><p>После этого заказчик начал искать нового подрядчика и в апреле 2022 года выбрал компанию Сибериан.Про.</p><p>В апреле-мае были преимущественно организационные работы и работы по подготовке мобильных приложений к публикации в Google Play и Apple Store, а я подключился к проекту в июне в качестве техлида проекта.
И сразу понял, что я серьёзно вляпался.</p></section><section class="doc-section level-1"><h2 id=_проблемы_проекта><a class=link href=#_проблемы_проекта>Проблемы проекта</a></h2><p>На второй день ознакомления с кодовой базой я в Slack-канал проекта написал такое сообщение:</p><div class=quote-block><blockquote><p>Я нашёл. Оно никогда не перестанет быть смешным и не потеряет актуальность
<a class=bare href=https://thecodinglove.com/content/039/gez23qJ.webm>https://thecodinglove.com/content/039/gez23qJ.webm</a></p></blockquote></div><p>Вот сразу мемасик из ссылки:</p><video controls autoplay>
<source src=https://thecodinglove.com/content/039/gez23qJ.webm type=video/webm>Your browser does not support the video tag.</video><p>В тот же день я завёл в слаке канал project-e-wtf - куда сливал свой яд от всевозможных находок в коде.</p><p>Находок было очень много, но наибольший WTF у меня вызывали три штуки:</p><div class="olist arabic"><ol class=arabic><li>Полное отсутствие каких бы то ни было тестов;</li><li>Неуместное применение микросервисной архитектуры и её неумелая реализация;</li><li>Использование вертикальной архитектуры на базе MediatR.</li></ol></div><p>Разберу их чуть подробнее.</p><section class="doc-section level-2"><h3 id=_отсутствие_тестов><a class=link href=#_отсутствие_тестов>Отсутствие тестов</a></h3><p>С тестами разбирать особо нечего - в кодовой базе не было ни одного теста.
И если отсутствие функциональных и интеграционных тестов можно объяснить сложностью тестирования микросервисной архитектуры, то отсутствие даже юнит-тестов на моках - для меня загадка, проектов без тестов я не видел с 2014 года.</p><p>В итоге, как только мы начали пытаться вносить изменения в систему - на нас тут же широкой рекой хлынули баги.</p></section><section class="doc-section level-2"><h3 id=_микросервисы><a class=link href=#_микросервисы>Микросервисы</a></h3><p>Изначально диаграмма контейнеров бэка проекта в нотации C4 выглядела так:</p><div class=image-block><a class="image bare" href=/drafts/project-e-retro/images/project-e-retro-backend.drawio.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/project-e-retro/images/project-e-retro-backend.drawio.svg alt="Диаграмма контейнеров бакэнда Проекта Э"></a></div><p>Притом в проекте не было ни одной объективной причины, которая бы оправдывала сложности в разработке, привносимые микросервисной архитектурой.</p><p>Изначальная бек-команда состояла из одного бэк-разработчика, соотвественно банально не было людей, между которыми надо было минимизировать коммуникации и конфликты.</p><p>Различных требований к масштабированию частей системы тоже не было и не предвидится.
На тот момент, когда я принял проект, он ещё не был зарелизан, и, соответственно, нагрузка на него была 0 rps, и все сервисы деплоились в единственном экземпляре.
Сейчас, спустя 8 месяцев опытной эксплуатации, у нас пиковая нагрузка составляет 0.5 rps.
А после выхода на расчётное количество пользователей, планируемая средняя нагрузка будет порядка 10-20 rps, а пиковая не превысит 100 rps.
Соответственно, никаких проблем с масштабированием не предвиделось и не предвидится - пара инстансов, созданных из соображений высокой доступности, с лёгкостью будет закрывать весь входящий поток запросов.</p><p>Единственное место, где ожидается сильный перекос - это база данных дневников.
Там мы ожидаем сотни миллионов-миллиарды строк, против десятков-сотен тысяч строк в остальных БД.
Но это будет в далёком и прекрасном будущем, а пока что их 300К с ростом на 3К в день.</p><p>Инфраструктура тоже была типовая и общая для большинства сервисов - PostgreSQL, RabbitMQ, и всё.
Только у модуля email-нотификаций была уникальная зависимость на smtp-транспорт.</p><p>Никаких других факторов, требующих такого уровня изоляции частей системы, тоже не было.</p><p>Но неуместное использование микросервисов - было только половиной беды.
Исполнение также хромало на обе ноги.</p><p>Во-первых, в проекте использовался разделяемый модуль shared - антипаттерн разработки МСов.
Который среди прочего включал DTO API сервисов.
Соответственно, разработка фичи, которая затрагивала несколько сервисов (а таких фич было большинство — подробности далее) зачастую состояла из следующих шагов:</p><div class="olist arabic"><ol class=arabic><li>Обновить модуль shared;</li><li>Собрать и опубликовать его;</li><li>Попытаться обновить сервер, обнаружить проблему в интерфейсе и вернуться на шаг 1;</li><li>Попытаться обновить клиент, обнаружить проблему в интерфейсе и вернуться на шаг 1;</li><li>Задеплоить сервер;</li><li>Задеплоить клиент.</li></ol></div><p>Отдельную пикантность ситуации придавало наличие сервиса share, который отвечал за предоставление доступа к данным пациентов - я не сразу заучил кто из них кто.</p><p>Во-вторых, микросервисы, опять же вопреки основополагающему принципу их дизайна, обладали высокой степенью сцепленности - практически каждая операция включала в себя синхронные обращения к другим микросервисам, которые в процессе обработки запросов снова шли в следующие микросервисы.</p><p>Например, вот так выглядело дерево вызовов в юзкейсе предпросмотра группы пациентов:</p><div class=image-block><a class="image bare" href=/drafts/project-e-retro/images/project-e-retro-create-group.drawio.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/project-e-retro/images/project-e-retro-create-group.drawio.svg alt="Диаграмма контекста Проекта Э"></a></div><p>В системе администраторы могут создавать группы из пациентов, наблюдаемых определёнными врачами.
И в юзкейсе создания новой группы на первом этапе (синие стрелки) выполняется выбор врачей с поиском по емейлу, а потом отображается состав группы для предпросмотра (зелёные стрелки).</p><p>А так выглядела генерация PDF-отчёта по наблюдаемому:</p><div class=image-block><a class="image bare" href=/drafts/project-e-retro/images/project-e-retro-generate-pdf-report.drawio.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/project-e-retro/images/project-e-retro-generate-pdf-report.drawio.svg alt="Диаграмма контекста Проекта Э"></a></div><p>Знаю, что некоторые эксперты по МСА считают такие деревья сетевых вызовов нормой, но, на мой взгляд, это совершенно не эргономично и соответственно не должно быть нормой.</p><p>В результате у команды были все сложности, свойственные микросервисной архитектуре, и не было ни одной проблемы, которую бы она решала.</p></section><section class="doc-section level-2"><h3 id=_вертикальная_архитектура_на_базе_mediatr><a class=link href=#_вертикальная_архитектура_на_базе_mediatr>Вертикальная архитектура на базе MediatR</a></h3><p>Это спорная тема и знаю, что такой подход популярен в .net-сообществе, однако мне он не нравится.
Для вертикальной архитектуры не существует единого определения и можно нагуглить множество разных вариаций её реализации.
Вариант, который был использован в Проекте Э, довольно подробно описан в <a href=https://medium.com/@yurexus/mediatr-outside-vertical-slice-architecture-and-why-you-are-probably-using-it-wrong-3bfd45b0fe0e>этом посте</a>.</p><p>Если вкратце, то использованный подход можно охарактеризовать так:</p><div class="olist arabic"><ol class=arabic><li>На каждую операцию в слое сервисов заводится отдельный класс-обработчик;</li><li>Доступ к данным размазан между репозиториями (модификация через EntityFramework) и обработчиками (чтение через строковые константы с SQL в обработчиках);</li><li>Контроллеры вместо прямого вызова сервисов отправляют команду в MediatR и он сам как-то определяет в какой класс-обработчик её передать.</li></ol></div><details><summary>Как выглядел типичный код</summary><div class=content><div class=listing-block><pre class="rouge highlight"><code data-lang=csharp><span class=k>namespace</span> <span class=nn>ProjectE.Share.Api.Controllers.Queries.GetObservables</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>GetObservablesQueryHandler</span> <span class=p>:</span> <span class=n>IRequestHandler</span><span class=p>&lt;</span><span class=n>GetObservablesQuery</span><span class=p>,</span> <span class=n>GetObservablesQueryResult</span><span class=p>&gt;</span>
    <span class=p>{</span>

        <span class=c1>// Поля и конструктор</span>

        <span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>GetObservablesQueryResult</span><span class=p>&gt;</span> <span class=nf>Handle</span><span class=p>(</span><span class=n>GetObservablesQuery</span> <span class=n>request</span><span class=p>,</span> <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>startIndex</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageSize</span> <span class=p>*</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>PageIndex</span> <span class=p>-</span> <span class=m>1</span><span class=p>);</span>
            <span class=k>const</span> <span class=kt>string</span> <span class=n>sql</span> <span class=p>=</span> <span class=s>@&#34;select count(*)
                                  from observers o
                                 where o.user_id = @userId and not o.is_deleted;
                                 select o.observable_id, obs.user_id
                                  from observers o
                                 inner join observables obs on obs.id = o.observable_id
                                 where o.user_id = @userId and not o.is_deleted
                                 limit @pageSize offset @startIndex&#34;</span><span class=p>;</span>

            <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ObservablesQueryResultDto</span> <span class=p>{</span><span class=n>Meta</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MetaDataDto</span> <span class=p>{</span><span class=n>CurrentPage</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageIndex</span><span class=p>,</span> <span class=n>PageSize</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageSize</span><span class=p>}};</span>
            <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>connection</span> <span class=p>=</span> <span class=k>new</span> <span class=nf>NpgsqlConnection</span><span class=p>(</span><span class=n>_options</span><span class=p>.</span><span class=n>Value</span><span class=p>.</span><span class=n>ConnectionString</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=k>await</span> <span class=n>connection</span><span class=p>.</span><span class=nf>OpenAsync</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>);</span>
                <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>multi</span> <span class=p>=</span> <span class=k>await</span> <span class=n>connection</span><span class=p>.</span><span class=nf>QueryMultipleAsync</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span>
                           <span class=k>new</span>
                           <span class=p>{</span>
                               <span class=n>userId</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>UserId</span><span class=p>,</span>
                               <span class=n>pageSize</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageSize</span><span class=p>,</span>
                               <span class=n>startIndex</span>
                           <span class=p>}))</span>
                <span class=p>{</span>
                    <span class=n>result</span><span class=p>.</span><span class=n>Meta</span><span class=p>.</span><span class=n>TotalItems</span> <span class=p>=</span> <span class=k>await</span> <span class=n>multi</span><span class=p>.</span><span class=n>ReadFirstAsync</span><span class=p>&lt;</span><span class=kt>long</span><span class=p>&gt;();</span>
                    <span class=n>result</span><span class=p>.</span><span class=n>Items</span> <span class=p>=</span> <span class=k>await</span> <span class=nf>ParseObservables</span><span class=p>(</span><span class=k>await</span> <span class=n>multi</span><span class=p>.</span><span class=n>ReadAsync</span><span class=p>&lt;</span><span class=kt>dynamic</span><span class=p>&gt;());</span>
                <span class=p>}</span>
            <span class=p>}</span>

            <span class=k>return</span> <span class=k>new</span> <span class=nf>GetObservablesQueryResult</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// Вспомогательные методы маппинга данных</span>

    <span class=p>}</span>
<span class=p>}</span></code></pre></div><p>А а в соседней директории был какой-нибудь такой код:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=csharp><span class=c1>// Аналогичный &#34;заголовок&#34;</span>

<span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>GetObservablesBySearchQueryResult</span><span class=p>&gt;</span> <span class=nf>Handle</span><span class=p>(</span><span class=n>GetObservablesBySearchQuery</span> <span class=n>request</span><span class=p>,</span>
    <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>var</span> <span class=n>startIndex</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageSize</span> <span class=p>*</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>PageIndex</span> <span class=p>-</span> <span class=m>1</span><span class=p>);</span>
    <span class=k>const</span> <span class=kt>string</span> <span class=n>sql</span> <span class=p>=</span> <span class=s>@&#34;select o.observable_id, obs.user_id
                         from observers o
                            inner join observables obs on obs.id = o.observable_id
                         where o.user_id = @userId and not is_deleted
                         limit @pageSize offset @startIndex&#34;</span><span class=p>;</span>

    <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ObservablesQueryResultDto</span> <span class=p>{</span> <span class=n>Meta</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MetaDataDto</span> <span class=p>{</span> <span class=n>CurrentPage</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageIndex</span><span class=p>,</span> <span class=n>PageSize</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>PageSize</span> <span class=p>}</span> <span class=p>};</span>

    <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>connection</span> <span class=p>=</span> <span class=k>new</span> <span class=nf>NpgsqlConnection</span><span class=p>(</span><span class=n>_options</span><span class=p>.</span><span class=n>Value</span><span class=p>.</span><span class=n>ConnectionString</span><span class=p>))</span>
    <span class=p>{</span>
        <span class=k>await</span> <span class=n>connection</span><span class=p>.</span><span class=nf>OpenAsync</span><span class=p>(</span><span class=n>cancellationToken</span><span class=p>);</span>
        <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>multi</span> <span class=p>=</span> <span class=k>await</span> <span class=n>connection</span><span class=p>.</span><span class=nf>QueryMultipleAsync</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span>
                   <span class=k>new</span>
                   <span class=p>{</span>
                       <span class=n>userId</span> <span class=p>=</span> <span class=n>request</span><span class=p>.</span><span class=n>UserId</span><span class=p>,</span>
                       <span class=n>pageSize</span> <span class=p>=</span> <span class=m>100</span><span class=p>,</span>
                       <span class=n>startIndex</span>
                   <span class=p>}))</span>
        <span class=p>{</span>
            <span class=n>result</span><span class=p>.</span><span class=n>Items</span> <span class=p>=</span> <span class=k>await</span> <span class=nf>ParseObservables</span><span class=p>(</span><span class=k>await</span> <span class=n>multi</span><span class=p>.</span><span class=n>ReadAsync</span><span class=p>&lt;</span><span class=kt>dynamic</span><span class=p>&gt;(),</span> <span class=n>request</span><span class=p>.</span><span class=n>Search</span><span class=p>);</span>
            <span class=n>result</span><span class=p>.</span><span class=n>Meta</span><span class=p>.</span><span class=n>TotalItems</span> <span class=p>=</span> <span class=n>result</span><span class=p>.</span><span class=n>Items</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=k>new</span> <span class=nf>GetObservablesBySearchQueryResult</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// Аналогичный &#34;футер&#34;</span></code></pre></div><p>А в "двоюродной" директории был такой код:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=csharp><span class=k>namespace</span> <span class=nn>ProjectE.Share.Api.Controllers.Commands.UpdateObserverCustomData</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>UpdateObserverCustomDataCommandHandler</span> <span class=p>:</span> <span class=n>IRequestHandler</span><span class=p>&lt;</span><span class=n>UpdateObserverCustomDataCommand</span><span class=p>,</span> <span class=n>UpdateObserverCustomDataCommandResult</span><span class=p>&gt;</span>
    <span class=p>{</span>

        <span class=c1>// Аналогичный &#34;заголовок&#34;</span>

        <span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>UpdateObserverCustomDataCommandResult</span><span class=p>&gt;</span> <span class=nf>Handle</span><span class=p>(</span><span class=n>UpdateObserverCustomDataCommand</span> <span class=n>command</span><span class=p>,</span> <span class=n>CancellationToken</span> <span class=n>cancellationToken</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>observable</span> <span class=p>=</span> <span class=k>await</span> <span class=n>_unitOfWork</span><span class=p>.</span><span class=n>ObservableRepository</span><span class=p>.</span><span class=nf>GetObservableByUserId</span><span class=p>(</span><span class=n>command</span><span class=p>.</span><span class=n>UserId</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>observable</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span> <span class=k>return</span> <span class=k>new</span> <span class=nf>UpdateObserverCustomDataCommandResult</span><span class=p>(</span><span class=n>CustomStatusCodes</span><span class=p>.</span><span class=n>NotFoundUserAccount</span><span class=p>,</span> <span class=k>new</span><span class=p>[]</span> <span class=p>{</span> <span class=s>&#34;Not found user observable account.&#34;</span> <span class=p>});</span>
            <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=k>await</span> <span class=nf>ChangeObserverCustomName</span><span class=p>(</span><span class=n>observable</span><span class=p>,</span> <span class=n>command</span><span class=p>.</span><span class=n>CustomName</span><span class=p>,</span> <span class=n>command</span><span class=p>.</span><span class=n>InviteId</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(!</span><span class=n>result</span><span class=p>)</span>
                <span class=n>_logger</span><span class=p>.</span><span class=nf>LogError</span><span class=p>(</span><span class=s>$&#34;Can&#39;t change observer #</span><span class=p>{</span><span class=n>command</span><span class=p>.</span><span class=n>InviteId</span><span class=p>}</span><span class=s> custom name&#34;</span><span class=p>);</span>

            <span class=k>return</span> <span class=k>new</span> <span class=nf>UpdateObserverCustomDataCommandResult</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// Аналогичный &#34;футер&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>namespace</span> <span class=nn>ProjectE.Share.Db.Repositories</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>ObservableRepository</span> <span class=p>:</span> <span class=n>IObservableRepository</span>
    <span class=p>{</span>

        <span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>Observable</span><span class=p>&gt;</span> <span class=nf>GetObservableByUserId</span><span class=p>(</span><span class=kt>int</span> <span class=n>userId</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>return</span> <span class=k>await</span> <span class=n>_context</span><span class=p>.</span><span class=n>Set</span><span class=p>&lt;</span><span class=n>Observable</span><span class=p>&gt;()</span>
                <span class=p>.</span><span class=nf>Include</span><span class=p>(</span><span class=n>o</span> <span class=p>=&gt;</span> <span class=n>o</span><span class=p>.</span><span class=n>Invites</span><span class=p>)</span>
                    <span class=p>.</span><span class=nf>ThenInclude</span><span class=p>(</span><span class=n>o</span><span class=p>=&gt;</span><span class=n>o</span><span class=p>.</span><span class=n>Status</span><span class=p>)</span>
                <span class=p>.</span><span class=nf>Include</span><span class=p>(</span><span class=n>o</span> <span class=p>=&gt;</span> <span class=n>o</span><span class=p>.</span><span class=n>Observers</span><span class=p>)</span>
                <span class=p>.</span><span class=nf>SingleOrDefaultAsync</span><span class=p>(</span><span class=n>o</span> <span class=p>=&gt;</span> <span class=n>o</span><span class=p>.</span><span class=n>UserId</span> <span class=p>==</span> <span class=n>userId</span><span class=p>);</span>
        <span class=p>}</span>

    <span class=p>}</span>
<span class=p>}</span></code></pre></div><p>Тут надо обратить внимание на то, что доступ к данным в двух классах содержался в строковых константах с SQL-ем, а в одном - в LINQ-выражении.</p></div></details><p>И из-за этой размазанности логики доступа к данным и отсутствия тестов у нас практически в каждом изменении были баги из серии "забыли поправить SQL в одном из слайсов".</p><p>MediatR же на этом фоне был мелким раздражителем, который приводил к:</p><div class="olist arabic"><ol class=arabic><li>Усложнению навигации по коду - вместо прыжка через метод, приходилось выполнять поиск по команде;</li><li>Необходимости на каждую операцию заводить по этой команде и её результату, даже если на вход подаётся один int, а на выход идёт один boolean;</li></ol></div><hr><p>После двух месяцев страданий у меня родилась гениальная идея:</p><div class=image-block><img src=/drafts/project-e-retro/images/the-idea.jpg alt="the idea"></div><p>* <em><a href=https://azhidkov.pro/ergo-approach/landing/>Эргономичный подход</a> - этой мой гайдлайн разработки кодовых баз, которые хочется развивать, а не сжечь.</em></p><p>Генеральный план обретения счастья был следующий:</p><div class="olist arabic"><ol class=arabic><li>Переписываем на Kotlin.
Не потому что .net плох, а потому что я не смог найти вменяемого .net-разработчика ни в штат, ни на аутстафе, а на Kotlin у меня было два крутых юниора;</li><li>Собираем всё в монолит.
Это уберёт лишние сложности разработки в моменте и, что важнее, упростит нам рефакторинг архитектуры;</li><li>На первом этапе сохраняем изначальную структуру модулей внутри монолита.
Для того чтобы переход на новый бэк был плавный, бесшовный и с минимальными сроками и рисками;</li><li>Покрываем всё функциональными тестами.
Это решит нам проблемы с багами в моменте и развяжет руки для рефакторинга архитектуры;</li><li>Реализацию модулей организуем в соответствии с функциональной/неизменяемой архитектурой.
Это упростит нам тестирование бизнес-логики и чтение кода в будущем;</li><li>После того как всё соберём в монолит, покрытий тестами не сцепленными с его реализацией - <a href=https://azhidkov.pro/posts/23/04/ergonomic-decomposition/#_декомпозиция_на_базе_эффектов>перепроектируем дизайн на базе эффектов</a> и постепенно отрефакторим код.
Это снизит сцепленность и повысит связанность системы и позволит нам быстрее реализовывать новые требования.</li></ol></div><aside class=sidebar><h6 class=block-title>Что я вынес для себя</h6><p>В конце каждого раздела этой серии я привожу выводы, которые я вынес для себя и, на мой взгляд, которые могут быть полезны вам.
И вот что я для себя вынес из работы с оригинальной кодовой базой Проекта Э:</p><div class="olist arabic"><ol class=arabic><li><a href=https://www.martinfowler.com/bliki/MonolithFirst.html>Фаулер</a>, <a href=https://www.oreilly.com/library/view/building-microservices/9781491950340/>Ньюман</a> и <a href=https://microservices.io/post/microservices/patterns/2020/10/18/microservices-are-a-mistake.html>Ричардсон</a> правы и проекты надо начинать с монолита;</li><li>Брать на поддержку проекты без тестов можно только при условии, что каждая задача на разработку начинается с покрытия тестами релевантного кода.
Сколько бы это ни стоило;</li><li>Мне вертикальная архитектура не подходит, можно на неё больше не смотреть.</li></ol></div></aside></section></section><section class="doc-section level-1"><h2 id=_история_получения_разрешения_на_реинжиниринг><a class=link href=#_история_получения_разрешения_на_реинжиниринг>История получения разрешения на реинжиниринг</a></h2><p>На самом деле, идея переписать всё по ЭП появилась у меня на второй день изучения проекта.
Но, очевидно, затея просто так прийти к РП или заказчику и предложить всё переписать к чёртовой матери была обречена на провал.
Поэтому свой генеральный план я вынашивал, старясь не привлекать внимание санитаров.</p><p>Благо состояние исходной кодовой базы было настолько плачевно, что за два месяца активных работ (точнее, попыток активной работы) это стало очевидным и для РП (а как выяснилось позже - и для заказчика).
И 5 августа в треде о том, что уже второй дотнетчик делает задачи слишком долго, она написала:</p><div class=quote-block><blockquote><p>А как crazy idea - Леш, а переписать все на джава это сколько долго?</p></blockquote></div><p>Я ушёл на 15 минут, посчитал количество таблиц и эндпоинтов, просуммировал их, получил ~120, добавил +/- 50% и ответил: 60 - 180 человеко/дней.</p><p>Затем, 11 августа я написал РП такое сообщение:</p><div class=quote-block><blockquote><p>Чёт не спится:)
Мне идея переписать на Котлине кажется всё более разумной и реальной.
Из оценки в 100 дней - 50% это покрытие автоматическими тестами, что надо делать в любом случае, чтобы не помереть под регрессиями.
&lt;…​>
ну и у нас ещё есть переезд на свежий дотнет, который XXX оценил в 8 дней, и без тестов это скорее всего оптимистичная оценка.
Короч давай продвигать эту авантюру Михаилу - будет страшно интересно :troll: но всё закончится хорошо и если начнём в августе - к НГ уже будут видны результаты в скорости и качестве работы</p></blockquote></div><p>После этого, 14 августа РП написала, что заказчик готов выслушать наше предложение и мы назначили встречу.</p><p>К встрече я подготовил презентацию, которая содержала:</p><div class="olist arabic"><ol class=arabic><li>"Погоны" - мой опыт, три успешных кейса реинжиниринга сопоставимого масштаба, работу над Эргономичным подходом;</li><li>Вышеописанные проблемы проекта.
Притом проблемы я приземлил на конкретные цифры - сколько заняли конкретные задачи и сколько обычно занимаю аналогичные задачи, к каким конкретным багам привела каждая из проблем, в целом статистику по багам в Проекте Э и других моих проектах;</li><li>Описанный выше генеральный план (без смены стека);</li><li>Предложение сменить стек, аргументированное тем, что разница в трудозатратах не такая большая, а в сроках и цене на самом деле будет выигрыш за счёт наличия хороших и проверенных кадров внутри компании;</li><li>Детальное описание процесса реинжиниринга.</li></ol></div><p>Заказчик сказал, что очень интересно и надо подумать.
И ушёл.
На месяц с лишним.</p><p>А 23 сентября РП и аккаунт на встрече с топ-менеджментом заказчика договорились о старте работ по реинжинирингу.
Мне же осталось только не обос…​ облажаться.</p><aside class=sidebar><h6 class=block-title>Что я вынес для себя</h6><p>При написании этого поста я прямым текстом спросил у заказчика о том, что повлияло на его положительное решение и вот его ответ:</p><div class=quote-block><blockquote><p>В первую очередь сроки реализации доработок для старой архитектуры, а также ваша презентация, она была довольно убедительной.
Желание повысить качество и быстродействие системы.</p></blockquote></div><p>Также по моему опыту других проектов реинжиниринга отдельных подсистем, могу сказать, что есть ещё два случая, в которых бизнес готов идти на реинжиниринг:</p><div class="olist arabic"><ol class=arabic><li>Очевидные операционные проблемы (производительность и стабильность), на которые жалуются клиенты и аргументированное обоснование того, что они не могут быть решены в рамках текущей архитектуры/технологий подсистемы;</li><li>Серьёзные изменения в требованиях, когда даже для неразработчика очевидно, что проще написать с нуля, чем модифицировать то, что есть.</li></ol></div><p>Однако, я думаю, что наличие проблем является необходимым, но недостаточным условием для того, чтобы бизнес согласился на реинжиниринг.
Достаточным же условием является доверие владельца продукта к вам.
Он должен верить вашим словам о невозможности решить проблему локальными изменениями, верить что вы справитесь с задачей, верить, что решение действительно исправит проблемы и верить, что вы действуете в его интересах.</p><p>Соответственно, для того чтобы владелец продукта дал разрешение на реинжиниринг надо:</p><div class="olist arabic"><ol class=arabic><li>Чтобы проблемы кодовой базы влияли на сроки разработки или конечных пользователей;</li><li>Сначала заработать доверие владельца продукта, а потом говорить, что это го*вно надо переписать к чёртовой матери.
При этом в презентации не постесняться рассказать о своих "погонах";</li><li>В обосновании необходимости реинжиниринга продемонстрировать, как проблемы кодовой базы ведут к проблемам, которые волнуют владельца продукта.
И опираться в этом на факты;</li><li>Проговорить, что конкретно вы будете делать по-другому, чтобы подобные проблемы не возникли вновь;</li><li>В деталях и по шагам описать процесс перехода от старой кодовой базы к новой.</li></ol></div></aside></section><section class="doc-section level-1"><h2 id=_планирование_реинжиниринга><a class=link href=#_планирование_реинжиниринга>Планирование реинжиниринга</a></h2><p>В первую очередь хочу предупредить: я не профессиональный менеджер и при планировании реинжиниринга импровизировал на ходу.
В моём случае это сработало и - если у вас нет другого варианта - вы можете пойти по тому же пути.
Если же вы сами эксперт в управлении - лучше придерживайтесь своего мнения:)
А если вы не эксперт, но можете делегировать эту работу эксперту - я бы на вашем месте так и сделал.</p><p>Импровизацию я начал с того, что попросил одного из разработчиков построить граф зависимостей оригинальной системы:</p><div class=image-block><img src=/drafts/project-e-retro/images/dependency-graph.png alt="dependency graph"></div><p>По факту это просто перечень REST-эндпоинтов (зелёные прямоугольники), RPC-эндпоинтов (синие) и обработчиков событий (красные) с обозначением вызовов, которые выполняются в процессе их исполнения.
Затем я пробежался по ним беглым взглядом, оценил в "майках" - XS (4 часа), S (8 часов), M (24 часа), L (40 часов), XL (80 часов) и визуализировал "размерный ряд" насыщенностью цвета прямоугольника.</p><p>"Линейка" при этом была следующая:</p><div class="olist arabic"><ol class=arabic><li>XS - Один тривиальный SQL-запрос или RPC-вызов;</li><li>S - Два-три тривиальных SQL-запроса и/или обращения к другому сервису;</li><li>M - Бизнес-логика не влазит на один экран;</li><li>L - Применялся в двух случаях, если:<ol class=loweralpha type=a><li>Это был первый эндпоинт сервиса;</li><li>Я не мог с ходу понять структуру и/или детали поведения эндпонита (понимая, при этом его эффекты);</li></ol></li><li>XL - у меня был только один.
Это был метод добавления событий, их было семь видов, каждый из которых мапился на таблицу с PostgreSQL-наследованием и имел не совпадающую по структуре входящую DTO-шку.</li></ol></div><p>Всего получилось работ на 354 xs или 177 человеко/дней.
Это соответствует верхней границе первоначальной оценки в 60-180 дней, однако включает в себя несколько новых фич на ~60 человеко/дней, которые мы успели сделать к моменту выполнения детальной оценки.</p><p>После этого я нарезал все прямоугольники на спринты.
Задачи в спринты я заталкивал довольно оптимистично, поэтому их получилось восемь штук по 160 человеко/часов в каждом — то есть всего 160 человеко/дней.
Но решил, что пускай мы лучше будем целиться в срок с запасом и первый план оставил таким.</p><p>Нарезку я делал интуитивно, руководствуясь следующими принципами (и балансируя между ними):</p><div class="olist arabic"><ol class=arabic><li>Набираем эндпоинты в спринты так, чтобы оценка задач в спринте примерно соответствовала суммарной мощности команды.
Тут мотивация очевидна, я думаю;</li><li>Идём снаружи внутрь - реинжинирим код только после того, как он перестаёт использоваться в оригинальной системе.
Это позволило нам, во-первых, не делать RPC-сервер в своей версии (который после перехода на монолит нам не понадобится), а, во-вторых, исключило вероятность того, что мы сломаем старый код, не покрытый тестами;</li><li>Фокусируемся на том, чтобы максимально быстро заканчивать каждый микросервис.
То есть лучше за одну неделю сделать полностью один МС и за вторую полностью второй, чем за неделю сделать два МСа на 50% и за вторую неделю доделать их полностью.
Это позволило нам минимизировать сложность роутинга в каждый момент времени, быстрее освобождать ресурсы кластера и, главное, минимизировать время, когда с БД одновременно работает старый и новый бэк, что могло привести к неприятным неожиданностям.</li><li>Стараемся все эндпоинты на одном URL сделать за один спринт.
Для упрощения роутинга и минимизации времени, когда с одними и теми же данными работают оба бэка;</li><li>Эндпоинты на одном URL стараемся делать в таком порядке - GET, DELETE, PUT, POST.
Это позволило снизить вероятность поломки старого бэка, какой-то "не такой" записью;</li><li>Стараемся, чтобы над одним МСом (хотя бы в рамках спринта) работал только один человек.
Это позволило нам минимизировать конфликты слияния.</li></ol></div><p>После того как у нас появился план, нам оставалось только лишь его придерживаться:)</p><aside class=sidebar><h6 class=block-title>Что я вынес для себя</h6><div class="olist arabic"><ol class=arabic><li>По возможности лучше делегировать планирование профессиональному управленцу;</li><li>Если делегировать невозможно - в аналогичном проекте я бы выполнил планирование так же;</li><li>Мёрж конфликты - очень дорогая штука, один из самых кровавых стоил нам двух дней разработки.
Соответственно, надо прикладывать максимум усилий по их исключению.</li></ol></div></aside></section><section class="doc-section level-1"><h2 id=_заключение><a class=link href=#_заключение>Заключение</a></h2><p>В следующем посте я расскажу, как мы организовали процесс работы команды, что пошло не по плану и как мы факапились в проде.</p></section></article></section></div></main><script src=/js/app.js></script></body></html>