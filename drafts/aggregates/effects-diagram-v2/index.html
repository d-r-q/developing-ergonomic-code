<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Диаграмма Эффектов v0.0.1 - Алексей Жидков"><meta property="og:description" content="Душой информационной системы являются её эффекты. Именно на основании эффектов конечные пользователи выносят суждения о корректности работы системы. И при столь большой важности эффектов, в мире не существовало инструмента для визуализации и проектирования эффектов. Поэтому я придумал свой - диаграмму эффектов"><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/drafts/aggregates/effects-diagram-v2/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/drafts/aggregates/effects-diagram-v2/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/drafts/aggregates/effects-diagram-v2/><title>Диаграмма Эффектов v0.0.1 - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/drafts/aggregates/effects-diagram-v2/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/ergo-approach/landing>Эргономичный подход</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/effects-diagram/landing>Диаграмма Эффектов</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Диаграмма Эффектов v0.0.1</h1></header><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Следить за обновлениями блога можно в моём канале: <a href=https://t.me/ergonomic_code>Эргономичный код</a></p></aside><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Этот пост является первой попыткой описать диаграмму формально, поэтому в описании возможны неточности и пробелы, а детали и нотация наверняка изменятся в будущем.</p></aside><section class="doc-section level-1"><h2 id=_введение><a class=link href=#_введение>Введение</a></h2><p>Эффекты, на ряду с моделью информации, являются душой информационной системы - что-то сохранить в БД, что-то запросить из внешнего сервиса, что-то запросить из нескольких источников, объединить это и записать куда-то, в общем как-то по взаимодействовать с окружающим миром.</p><p>Можно переписать приложение с Java на Haskel, сменить слои на шестиугольную архитектуру, реляционную базу данных заменить документной, а пользовательский интерфейс перевести с Web 1.0-ого на React Native - если эффекты системы останутся неизменными, то и новая система будет просто вариацией на тему условной библиотеки.
Если же существенно изменить эффекты системы, то это будет уже другая система.</p><p>Наконец, именно на основании эффектов конечные пользователи выносят суждения о корректности работы системы.
Даже если функция системы включает в себя сложные вычисления, корректность их результата конечный пользователь сможет оценить только если корректно отработал эффект отображения результата - воздействие на органы чувств пользователя, в конечном итоге.</p><p>При всей значимости эффектов я не знаю ни одного общепринятого инструмента их визуализации.
Поэтому изобрёл свой - диаграмму эффектов.</p></section><section class="doc-section level-1"><h2 id=_терминология><a class=link href=#_терминология>Терминология</a></h2><p>Системы очень редко выполняют <strong>эффекты</strong> сплошным потоком - обычно система выполняет набор эффектов в ответ на какое-то <strong>событие</strong> и засыпает до следующего события.
Таким событием может быть получение вызова удалённой процедуры в любом виде, появление нового сообщения в некоторой очереди, наступление определённого момента времени или истечение определённого периода времени.</p><p>Как правило, для реализации функции системы требуется несколько эффектов, как минимум что-то считать и потом записать обратно.
Группы эффектов реализующих одну функцию системы образуют <strong>операции</strong> системы.
Система может реагировать как несколькими операциями, в ответ на одно событие, так и одной операцией в ответ на несколько событий (разных типов).</p><p>Наконец, у эффектов есть целевое состояние - какая-то часть физического мира, которая изменит своё состояние или наоборот состояние которой будет оцифровано и предоставлено программе результате выполнения эффекта.
Чаще всего целевым состоянием выступают биты на носителях информации, но это могут быть и пиксели экрана, и динамик колонки и нога робота.
Эти кусочки физического мира представленны их абстракциями в системе - <strong>ресурсами</strong>.</p><p>Чёткое понимание триады События-Эффекты-Ресурсы - в ответ на какие события, какими эффектами на какие ресурсы система должна реагировать - крайне полезно на всех этапах жизненного цикла разработки системы.</p><p>На этапе оценки триада помогает осознать количество функций системы и примерную трудоёмкость реализации каждой из них.</p><p>На этапе проектирования операции и ресурсы становятся основными блоками, правильная декомпозиция которых создаст основу для системы с низкой сцепленностью.</p><p>На этапе реализации зависимости операций через ресурсы и их оценочная сложность (определяемая количеством и типом обеспечивающих её ресурсов) помогают определить порядок выполнения работ и те работы, которые могут быть выполнены параллельно.</p><p>Наконец, на этапе поддержки сцепленность операций через ресурсы помогают спрогнозировать последствия планируемого изменения и предотвратить внесение регрессий.</p><p>Визуализация триады События-Эффекты-Ресурсы является основным предназначением диаграммы эффектов.</p></section><section class="doc-section level-1"><h2 id=_диаграмма_эффектов_v0_0_1><a class=link href=#_диаграмма_эффектов_v0_0_1>Диаграмма эффектов v0.0.1</a></h2><p>Диаграмма эффектов помогает увидеть целостную картину поведения системы - как и на какие события она реагирует.
Для этого она представляет систему с точки зрения операций (ответственностей, поведения) системы.
Каждая операция характеризуется набором событий, приводящей к её исполнению и набором ресурсов, необходимых для её исполнения.
События и операции связаны вызовами (не важно, синхронными или асинхронными).
Операции и ресурсы связаны обращениями на чтение и запись - эффектами.</p><p>Все элементы транслируются непосредственно в код: события и операции - в методы, ресурсы - в классы, стрелки - в вызовы методов.
Операции всегда транслируются в методы классов слоя сервисов приложения - методы определяющие публичный интерфейс модуля.
При том при реализации этих методов следует стремиться к тому, чтобы все вызовы соответствующие эффектам оказались в самих методах, а не погребённых где-то в недрах реализации.
Перевод диаграммы эффектов в код я рассмотрю в одном из ближайших постов.</p><p>Если говорить о бакэндах информационных систем, то самыми распространёнными видами событий являются:</p><div class="olist arabic"><ol class=arabic><li>Получение запроса по сети.
Сейчас популярностью пользуется протокол запросов в REST-стиле, но SOAP, gRPC, CORBA и т.п. так же попадают в эту категорию.</li><li>Появление сообщения в очереди.
Это может быть как и "вне-процессная" очередь, вроде ActiveMQ, так и "внутри-процессная" очередь вроде Spring Application Event Publisher.</li><li>Наступление определённого момента времени.
Два основных типа таких событий - наступление заранее известного момента времени (например, полуночи вторника) и истечение определённого времени с момента в прошлом (например, истечение суток с момента создания предыдущего бэкапа).</li></ol></div><p>В коде события превращаются в метод, передаваемый фреймворку для последующего вызова - метод Spring-ового RestController-а, Swing-овый EventListener, реализация Runnable для таймера и т.д.</p><p>В контексте бэкэндов информационных систем, самыми распространёнными видами ресурсов являются такие:</p><div class="olist arabic"><ol class=arabic><li>Любые постоянные коллекции данных - таблицы в реляционной СУБД, коллекции в документной СУБД и т.д.</li><li>REST API внешних сервисов</li><li>Любые очереди сообщений/шины данных</li><li>Глобальные изменяемые структуры данных</li></ol></div><p>В коде ресурсы превращаются в структуру данных и коллекцию методов работы с ней - Spring Data JDBC агрегат и Spring Data JDBC репозиторий, событие и Spring Application Publisher, REST API модель и клиент и т.п.</p></section><section class="doc-section level-1"><h2 id=_нотация><a class=link href=#_нотация>Нотация</a></h2><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Нотация - это то, что я точно существенно перетрясу с помощью специально обученных людей перед релизом версии 1.0.</p></aside><p>"Визуальный язык" диаграммы эффектов я взял из <a href=https://c4model.com/>модели C4</a>.
Во-первых мне нравится сам язык, а во-вторых, диаграмму эффектов можно встроить в модель C4, на четвёртом уровне - вместо кода.
Кроме того, диаграмму третьего уровня (компонентов) я строю как раз базе диаграммы эффектов.</p><p>Диаграмма эффектов бывает двух типов - краткая и полная.
Краткая содержит только обозначение эффектов и связанных ими операций и ресурсов.
Полная нотация дополнительно включает события и их источники, внешние системы, обеспечивающие реализацию ресурсов и более полное описание всех элементов.</p><p>Рассмотрим нотации с помощью минимального примера визуализации функциональности регистрации и аутентификации пользователей в произвольной системе.
После успешной регистрации пользователям необходимо отправлять приветственное письмо.
Начнём с краткой нотации.</p><section class="doc-section level-2"><h3 id=_краткая_нотация><a class=link href=#_краткая_нотация>Краткая нотация</a></h3><p>В краткой нотации диаграмма выглядит следующим образом (картинка кликабельна):</p><div class=image-block><a class="image bare" href=/drafts/aggregates/images/short-notation-example.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/aggregates/images/short-notation-example.svg alt="short notation example"></a></div><p>Теперь рассмотрим отдельные элементы</p><section class="doc-section level-3"><h4 id=_операции><a class=link href=#_операции>Операции</a></h4><p>Операции обозначаются светло-голубым прямоугольником с именем операции:</p><div class=image-block><img src=/drafts/aggregates/images/operation.svg alt=operation></div></section><section class="doc-section level-3"><h4 id=_ресурсы><a class=link href=#_ресурсы>Ресурсы</a></h4><p>Ресурсы обозначаются голубым прямоугольником с именем ресурса:</p></section><section class="doc-section level-3"><h4 id=_эффекты><a class=link href=#_эффекты>Эффекты</a></h4><div class=image-block><img src=/drafts/aggregates/images/resource.svg alt=resource></div><p>Эффект модификации ресурса обозначается жирной красной стрелкой от операции к ресурсу, с кратким описанием эффекта:</p><div class=image-block><img src=/drafts/aggregates/images/operation-resource-rw.svg alt="operation resource rw"></div><p>Эффект чтения ресурса обозначается синей стрелкой от ресурса к операции, с кратким описанием считываемых данных:</p><div class=image-block><img src=/drafts/aggregates/images/operation-resource-ro.svg alt="operation resource ro"></div></section><section class="doc-section level-3"><h4 id=_эффекты_вызова_операций><a class=link href=#_эффекты_вызова_операций>Эффекты вызова операций</a></h4><p>В краткой нотации так же есть специальный вид стрелок для отражения того факта, что взаимодействие с ресурсом может повлечь выполнение операции.
Как правило, это ресурсы всевозможных шин событий и связанные с ними операции-обработчики.
Такие связи отображаются красной прерывистой линией с кратким описанием связи:</p><div class=image-block><img src=/drafts/aggregates/images/resource-operation-rw.svg alt="resource operation rw"></div></section><section class="doc-section level-3"><h4 id=_примечания><a class=link href=#_примечания>Примечания</a></h4><p>Дополнительно на диаграмму можно помещать заметки и примечания, используя любую удобную нотацию.
Я предпочитаю нотацию UML - "лист" с загнутым углом, связанный прерывистой линией с комментируемым элементом.</p><div class=image-block><img src=/drafts/aggregates/images/note.svg alt=note></div><p>На этом элементы входящие в краткую нотацию заканчиваются.</p></section></section><section class="doc-section level-2"><h3 id=_полная_нотация><a class=link href=#_полная_нотация>Полная нотация</a></h3><p>Теперь рассмотрим ту же функциональность, описанную в полной нотации:</p><div class=image-block><a class="image bare" href=/drafts/aggregates/images/full-notation-example.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/aggregates/images/full-notation-example.svg alt="full notation example"></a></div><p>В полной нотации появляются:</p><div class="olist arabic"><ol class=arabic><li>события</li><li>описание операций и ресурсов в формате модели C4</li><li>границы контейнера из C4.
Обозначает границы процесса - всё что находится внутри этих границ должно выполняться в памяти визуализируемого приложения.</li><li>внешние системы, базы данных и компоненты из C4.
Внешние системы могут быть как источником события, так и средством реализации ресурса.</li></ol></div><p>Расширять состав элементов можно постепенно, добавляя только те элементы, что помогают в решении текущей задачи.</p><section class="doc-section level-3"><h4 id=_события><a class=link href=#_события>События</a></h4><p>На мой взгляд, из дополнительных элементов наибольшую ценность имеют события.
В полной нотации они обозначаются стрелкой от внешней системы к операции с кругом на стартовом конце и описанием в формате C4.
Но в промежуточной версии, внешнюю систему можно опустить и "подвесить" стрелку:</p><div class=image-block><img src=/drafts/aggregates/images/event-operation.svg alt="event operation"></div></section><section class="doc-section level-3"><h4 id=_описания><a class=link href=#_описания>Описания</a></h4><p>Затем можно дополнить операции и ресурсы - типом, способом реализации и описанием:</p><div class=image-block><img src=/drafts/aggregates/images/descriptions.svg alt=descriptions></div></section><section class="doc-section level-3"><h4 id=_внешние_системы><a class=link href=#_внешние_системы>Внешние системы</a></h4><p>Границы системы и внешние системы полностью соответствуют нотации C4:</p><div class="olist arabic"><ol class=arabic><li>Границы отображаются серым прямоугольником с прерывистой границей и подписью с именем контейнера</li><li>Неуправляемые внешние системы и компоненты и базы данных обозначаются серыми прямоугольниками и символом "База Данных" соответственно</li><li>Управляемые внешние системы и базы данных обозначаются голубым прямоугольником и символом "База Данных"</li></ol></div><p>Внешние системы связываются с операциями посредством событий:</p><div class=image-block><img src=/drafts/aggregates/images/event-sources.svg alt="event sources"></div><p>А ресурсы связываются со внешними системам по средствам стрелок с описанием:</p><div class=image-block><img src=/drafts/aggregates/images/resource-impls.svg alt="resource impls"></div><p>Ресурс может быть связан со сторонним компонентом, работающем в том же процессе:</p><div class=image-block><img src=/drafts/aggregates/images/resource-component.svg alt="resource component"></div><p>Здесь приведена, связь ресурса с эффектом вызова операции системы, в случае же если ресурс не обладает таким эффектом, то соединяются со сторонним компонентом обычной стрелкой.</p><p>Выбор нотации зависит от решаемой задачи.
Если надо быстро разбить систему на модули, или спланировать модификацию сложной или незнакомой операции - можно обойтись краткой нотацией.
Если надо оценить проект для работы за фиксированную цену - лучше взять полную нотацию, чтобы минимизировать вероятность "потери" существенных деталей.</p><p>Одним из плюсов базирования на визуальном языке модели C4 является то, что для диаграммы эффектов можно использовать любой инструмент с поддержкой C4.
А в силу простоты C4 таким элементом может быть хоть графический редактор.
Тем не менее, поддержка привязки элементов сильно помогает, поэтому я сам сейчас использую <a href=https://www.diagrams.net/>десктопную версию draw.io</a>.</p><p>Давайте рассмотрим диаграмму эффектов реального проекта и процесс её построения.</p></section></section></section><section class="doc-section level-1"><h2 id=_диаграмма_эффектов_системы_актуализации_данных_в_яндекс_картах_и_2гис_true_story_project_tsp><a class=link href=#_диаграмма_эффектов_системы_актуализации_данных_в_яндекс_картах_и_2гис_true_story_project_tsp>Диаграмма эффектов системы актуализации данных в Яндекс.Картах и 2Гис (True Story Project, TSP)</a></h2><p>Я сейчас заканчиваю небольшой проект по автоматизации обновления информации о компании в Яндекс.Картах 2Гис.
Это идеальный проект для иллюстрации диаграммы эффектов - он небольшой, но включает все основные типы событий и ресурсов:</p><div class=image-block><a class="image bare" href=/drafts/aggregates/images/true-story-effects.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/aggregates/images/true-story-effects.svg alt="true story effects"></a></div><p>Все новые коммерческие проекты я начинаю с диаграммы эффектов по целому ряду причин.</p><p>На этапе оценки диаграмма эффектов помогает определить основные блоки реализации, убедиться, что ничего не забыто и понятно как реализовать каждую из операций системы.
А формула <code>(&lt;кол-во операций>+&lt;кол-во ресурсов>) * 12 часов</code> даёт хорошее первое приближение трудоёмкости работы.</p><p>Затем я использую диаграмму эффектов для разбиения системы на модули.
Полученные модули и явные и, что важнее, неявные связи между ними я использую для определения порядка выполнения работ и работ, которые могут выполняться параллельно.</p><p>Итак, поехали.
На старте у меня было ТЗ, которое можно ужать до следующих пунктов:</p><div class="olist arabic"><ol class=arabic><li>У заказчика есть проблема: ему необходимо держать информацию об его организациях в ряде геосервисов в актуальном состоянии</li><li>Ключевым геосервисом являются Яндекс Карты, но дополнительно необходимо учитывать работу с 2Гис</li><li>Интеграция с Яндекс Картами заключается в том, что робот Яндекса приходит на специально выделенный URL и забирает оттуда фид в <a href=https://yandex.ru/support/business-priority/branches/xml-feed-sprav.html#q1__6>проприетарном XML-формате</a></li><li>Интеграция с 2Гисом выполняется посредствам отправки фида на Email, но уже в другом формате</li><li>Организаций у заказчика существенно больше тысячи, поэтому фид необходимо регулярно обновлять</li><li>Яндекс требует, чтобы фид всегда был доступен по заданному URL, поэтому необходимо обеспечить постоянное хранение последнего сгенерированного фида</li><li>Список организаций необходимо получать из специального сервиса заказчика по REST API</li><li>Ещё часть данных хранится во внутренней СУБД заказчика и извлекается с помощью JDBC и SQL-запроса, предоставленного заказчиком</li><li>Наконец, фид может содержать ссылки на фотографии организаций, и управление этими фотографиями должен обеспечить разрабатываемый сервис.
Доступ к этой функциональности должен быть обеспечен посредством REST API.
Конкретное хранилище изображений можно выбрать на своё усмотрение.</li></ol></div><p>Работу можно начать сразу с построения диаграммы эффектов, но я обычно в первом проходе составляю просто списки событий, операций и ресурсов, т.к. по мере вычитки ТЗ их состав наверняка будет меняться и уточняться.
Кроме того, при первой вычитке ТЗ я обычно строю первую версию ER-диаграммы, но в данном случае модель данных примитивная я не буду усложнять пример её построением.</p><p>Поэтому давайте пройдёмся по "ТЗ" и сделаем на его основе три артефакта: список операций системы, список событий системы и список ресурсов.</p><p>Из пунктов №1 и 2 ясно, что потребуются интеграции с Яндексом и 2Гисом, но пока не понятно как их реализовывать.
Кроме того, из этих пунктов мы можем предположить, что нам потребуется ресурс <strong>"Коллекция организаций"</strong> (Organizations) - его можно загодя добавить в список ресурсов.</p><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Так как все элементы диаграммы эффектов в последствии превратятся в код, а в коде имена пишутся на английском, на диаграмме я использую английский язык.
Кроме того, в среднем длина английской фразы меньше длины русского аналога, что является приятным бонусом для диаграммы.
Но чтобы не возводить лишний барьер, в посте я буду использовать русские имена, а при их первом появлении - указывать английский аналог.</p></aside><p>Пункт №3 проясняет способ интеграции с Яндексом - теперь можно удалить соответствующий ресурс и заменить его на операцию <strong>"Предоставить фид Яндекса"</strong> (getYandexFeed) и событие <strong>"(Получен HTTP-запрос) GET /feed/yandex"</strong> (сейчас нет смысла тратить время на проектирование хорошего REST API - достаточно просто уникально обозначить события).
На текущем этапе кажется, что эта операция может быть обеспечена ресурсом <strong>"Коллекция организаций"</strong>, поэтому новых ресурсов добавлять не будем.</p><p>Пункт №4 проясняет интеграцию с 2Гис и показывает, что нам потребуется событие <strong>"Настал момент отправки фида в 2Гис"</strong> (пока не понятно что это за момент) и ресурс <strong>"Email сервер"</strong> (Email Server) - вносим их в соответствующие списки.</p><p>Пункты №5-6 помогают нам внести ряд уточнений:</p><div class="olist arabic"><ol class=arabic><li>Появляется новое событие <strong>"Истёк срок действия фида"</strong> (FeedExpired), которое инициирует операцию <strong>"Сгенерировать обновлённый фид"</strong> (rebuildFeed).</li><li>Событие <strong>"Настал момент отправки фида в 2Гис"</strong> на самом деле является событием <strong>"Сгенерирован обновлённый фид"</strong> (NewFeedGenerated) - обновляем его в списке событий</li><li>Нам требуется где-то хранить фид для Яндекса между его генерацией и запросом - добавляем ресурс <strong>"Фид Яндекса"</strong> (Yandex Feed)</li></ol></div><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>В этом примере у меня случайно получился удачный порядок требований, который естественным образом привёл меня к расцепке операции генерации фида и его доставки геосервисам через событие.
Однако могло получиться и по другому.
Могло бы получиться так, что операция rebuildFeed оказалась связанной эффектами записи уже с двумя ресурсами сильно разными - YandexFeed и Email Server.</p><p>Это стало бы нарушением принципа единственности ответственности и благодаря диаграмме эффектов это нарушение сразу стало бы очевидным.</p><p>Вообще у меня есть эвристическое правило, что операция должна иметь один модифицирующий эффект и все операции с двумя и более такими эффектами я всегда подвергаю тщательному анализу.</p><p>А если бы на текущем этапе я не заметил бы ни нарушения SRP, ни собственного эвристического правила, то диаграмма эффектов привела бы меня сюда снова на этапе декомпозиции системы на модули.
Но об этом я напишу во врезке соответствующего поста.</p></aside><p>Пункт №7 уточняет способ реализации ресурса <strong>"Коллекция организаций"</strong> - REST, уточняем его в списке.</p><p>Пункт №8 определяет ещё один ресурс операции <strong>"Построить фид"</strong> - <strong>"JDBC: Дополнительная информация"</strong> (Additional Information), добавляем его в список.</p><p>Наконец, пункт №9 определяет новый ресурс <strong>"Фотографии"</strong> (Photos) и набор операций <strong>"Добавить фото организации"</strong>, <strong>"Получить фото организации"</strong>, <strong>"Получить список фото организации"</strong>, <strong>"Удалить фото организации"</strong>, с набором соответствующих событий об обращениях к HTTP эндпоинтам.</p><p>В итоге у нас получились следующие списки.</p><p>События:</p><div class="olist arabic"><ol class=arabic><li>HTTP: GET /feed/yandex</li><li>Event Bus: Сгенерирован новый фид</li><li>Scheduler: Истёк срок действия фида</li><li>HTTP: POST /images/{org_id}</li><li>HTTP: GET /images/{org_id}/{image_id}</li><li>HTTP: GET /images/{org_id}</li><li>HTTP: DELETE /images/{org_id}/{image_id}</li></ol></div><p>Операции:</p><div class="olist arabic"><ol class=arabic><li>Предоставить фид Яндекса</li><li>Построить фид</li><li>Добавить фото организации</li><li>Получить фото</li><li>Получить список фото организации</li><li>Удалить фото</li></ol></div><p>Ресурсы:</p><div class="olist arabic"><ol class=arabic><li>REST: Коллекция организаций</li><li>Email-сервер</li><li>???: Фид Яндекса</li><li>JDBC: дополнительная информация</li><li>???: Фотографии</li></ol></div><p>Теперь построим первую версию диаграммы эффектов, просто перенося элементы и попутно отмечая связи между ними.
Как именно переносить - сверху вниз, снизу вверх или в случайном порядке - не так важно.
Я предпочитаю идти по событиям, но для каждого события целиком раскрывать его реализацию.</p><p>Например, если начать с события <strong>"GET /feed/yandex"</strong>, то следом идут операция <strong>"Предоставить фид Яндекса"</strong> и ресурс <strong>"Фид Яндекса"</strong>, связанные через эффект чтения - добавляем на диаграмму.
Но откуда информация возьмётся в ресурсе?
Вследствии реакции на событие <strong>"Сгенерирован новый фид"</strong>, которое вызывает незамеченную ранее операцию <strong>"Обновить фид Яндекса"</strong> - добавляем их на диаграмму.</p><p>Операции <strong>"Обновить фид Яндекса"</strong> помимо ресурса <strong>"Фид Яндекса"</strong> потребуется и ресурс <strong>"Библиотека работы с XML"</strong>, но диаграмма эффектов потому и так называется, что фокусируется на ресурсах с состоянием.
Поэтому ресурсы без состояния я добавляю только в том случае, если они являются единственным ресурсом операции или в чём-то неординарны - стоят денег, непонятно какую библиотеку выбрать или с ними связаны какие-то другие риски.
И т.к. тут у нас вторичный и вполне ординарный ресурс, я его опускаю, чтобы сохранить фокус.</p><p>Далее у нас есть два пути - развернуть вторую операцию события <strong>"Сгенерирован новый фид"</strong> (отправку в 2Гис) или понять откуда у нас будет браться новый фид.
И так как первый путь короче - сначала быстро пройдём его, а потом вернёмся к самой сложной части - добавляем на диаграмму операцию <strong>"Отправить фид в 2Гис"</strong> и ресурс <strong>"Email-Server"</strong>.
Добавив ресурс, мы задумаемся, а не слишком ли он специфицирован?
Кажется да, поэтому Email-Server делаем стереотипом способа реализации, а саму операцию обозначаем как <strong>"Механизм отправки фида в 2Гис"</strong>.</p><p>Теперь возвращаемся к вопросу откуда у нас берётся новый фид.
Он генерируется операцией <strong>"Построить фид"</strong> в ответ на событие <strong>"Истёк срок действия фида"</strong> - добавляем их на диаграмму.
Но событие <strong>"Сгенерирован новый фид"</strong> является внутренним - мы сами должны позаботиться о его отправке.
И для этого нам нужен ресурс.
На текущем этапе кажется, что стандартного Spring Application Event Publisher будет вполне достаточно для решения этой задачи - добавим ресурс <strong>"&lt;&lt;Spring Application Event Publisher>>: Топик сгенерирован новый фид"</strong>.</p><p>Здесь мы подходим к одному из не до конца проработанных мест в диаграмме эффектов - мне хочется отразить тот факт, что событие <strong>"Сгенерирован новый фид"</strong> публикуется операцией <strong>"Сгенерировать новый фид"</strong>, но у меня нет ощущения, что эта связь хорошо ложится на текущую концепцию диаграммы.
Тем не менее, на мой взгляд эта связь очень важна, поэтому отразим её серой стрелкой от ресурса <strong>"Топик сгенерирован новый фид"</strong> к событию <strong>"Сгенерирован новый фид"</strong>.</p><p>Для того чтобы породить событие <strong>"Сгенерирован новый фид"</strong>, нам нам надо этот самый новый фид сгенерировать, а для его генерации нужны ресурсы - <strong>"Организации"</strong>, <strong>"Дополнительная информация"</strong> и <strong>"Фотографии"</strong> - добавляем их на диаграмму.</p><p>В этот момент я могу задуматься о том, как будет реализована операция <strong>"Сгенерировать новый фид"</strong> - я пробегусь по списку организаций, для каждой организации подтяну дополнительную информацию и фотографии - все необходимые ресурсы есть.</p><p>Кроме того, мне надо будет проверить что внешние ресурсы предоставляют мне нужное API.
А при выборе способа реализации ресурса <strong>"Фотографии"</strong>, который меня пока под вопросом, мне надо будет убедиться, что выбранный способ обеспечит возможность хранения привязки файлов фотографий к организациям.
Но я это пока просто помечу в заметках по проекту и продолжу строить диаграмму эффектов.</p><p>Текущую ветку мы прошли до конца - можем вернуться к спискам, вычеркнуть то, что уже перенесли на диаграмму и обнаружить, что у нас остались только события и операции API управления фотографиями - переносим их на диаграмму и немного полируем раскаладку.</p><p>На диаграмме осталась пара вопросов - как реализовать ресурсы <strong>"фид Яндекса"</strong> и <strong>"Коллекция фотографий"</strong>.
Сами фотографии явно лучше хранить в хранилище BLOB-ов вроде Amazon S3.
Там же можно хранить и фид Яндекса - у этого ресурса тривиальное API сохранения и получения файла по ключу.</p><p>Но при ближайшем рассмотрении, выясняется, что с фотографиями есть нюанс - помимо операций по ключу есть и поиск по организации.
Теоретически это можно реализовать посредствам бакетов или "папок" S3, но на мой вкус это решение уже начинает дурно пахнуть.
А чуть позже, когда мы внимательнее изучим формат фида Яндекса, мы увидим что у фотографий есть ещё и мета информация в виде типа и тэгов - хранить в S3 это будет уже совсем плохой идеей.
Значит нам нужна более продвинутая СУБД, у меня по умолчанию - PostgreSQL.</p><p>Но хранить в PostgreSQL сотни гигабайт - тоже сомнительная затея.
Значит реализацию ресурса <strong>"Коллекция фотографий"</strong> будет состоять из двух частей - <strong>"Коллекция файлов"</strong> и <strong>"Коллекция мета информации"</strong>.
Модификации этих ресурсов должны быть атомарными, поэтому на диаграмме я не буду разделять ресурс, а добавлю примечание.</p><p>В итоге мы получаем финальный вариант диаграммы эффектов микросервиса "Геосервисы" (картинка кликабельна):</p><div class=image-block><a class="image bare" href=/drafts/aggregates/images/geoservices-effects-diagram.drawio.svg title="Open the image in full size" aria-label="Open the image in full size"><img src=/drafts/aggregates/images/geoservices-effects-diagram.drawio.svg alt="geoservices effects diagram.drawio"></a></div></section><section class="doc-section level-1"><h2 id=_заключение><a class=link href=#_заключение>Заключение</a></h2><p>При первичном анализе и проектировании проекта, построение диаграммы эффектов и тщательная медитация над ней даёт много полезной информации - общее видение реализации системы, масштаб планируемых работ и их трудоёмкость, примерный план работ.</p><p>Построение диаграммы эффектов так же является полезным упражнением и при планировании модификации сложной или незнакомой системы - диаграмма поможет понять назначение модифицируемого кода и какой другой код может быть сломан в результате модификаций.</p><p>Однако самым крутым применением диаграммы эффектов является объектно-ориентированная декомпозиция системы на модули на её базе.
Разбор декомпозиции микросервиса "Геосервисы" на модули приведён в следующем посте.</p></section></article></section></div></main><script src=/js/app.js></script></body></html>