<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Перевод сервиса на Spring Boot Native - Алексей Жидков"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/microposts/23/09/spring-boot-native/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/microposts/23/09/spring-boot-native/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/microposts/23/09/spring-boot-native/><title>Перевод сервиса на Spring Boot Native - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/microposts/23/09/spring-boot-native/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/ergo-approach/landing>Эргономичный подход</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/effects-diagram/landing>Диаграмма Эффектов</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Перевод сервиса на Spring Boot Native</h1></header><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Этот материал является "микропостом" - текстом, написанным в режиме потока сознания без особой редактуры.</p><p>Следить за обновлениями блога можно в моём канале: <a href=https://t.me/ergonomic_code>Эргономичный код</a></p></aside><p>Я начал двигать <a href=https://azhidkov.pro/posts/23/09/project-e-part1/>Проект Э</a> в сторону микроядерной архитектуры.
Пока план такой что, в оригинальном монолите останутся ядерные модули, которые, частично в силу предметной области, а частично в силу дизайна оригинального бэка, который я перенёс как есть при реинжинирнге, довольно сильно сцеплены между собой, а интеграции (которых у нас уже три и предвидится ещё пачка) мы будем делать в отдельных сервисах.</p><p>Но есть нюанс - на дев стенде у нас дефицит памяти.
Поэтому я пошёл смотреть на Spring Boot Native.</p><p>Посмотрел, и в этом микропосте поделюсь впечатлениями.</p><section class="doc-section level-1"><h2 id=_сервис><a class=link href=#_сервис>Сервис</a></h2><p>Эксперементировать, естественно, я начал на котике - сервисе, реализующим интеграцию с ЕМИАС, о котором я <a href=https://azhidkov.pro/microposts/23/08/emias-integration/>уже писал</a>.
В сервисе 65 продовых котлин-файлов, он выставляет один HTTP-эндпоинт и слушает одну очередь в RabbitMQ и ходит в два HTTP-эндпоинта ЕМИАСа и публикует сообщения в один топик Кафки ЕМИАСа.
Так же сервис пишет данные в три таблички через Spring Data JDBC.</p><p>Сервис сделан на JDK 17, Kotlin 1.9, Spring Boot 3.1.3 и собирается Гредлом 8.2.1 с билд-файлом на Kotlin DSL.</p><p>Зависимости проекта:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springframework.boot:spring-boot-starter-web&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springframework.boot:spring-boot-starter-security&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springframework.boot:spring-boot-starter-data-jdbc&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springframework.boot:spring-boot-starter-amqp&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springframework.boot:spring-boot-starter-actuator&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springdoc:springdoc-openapi-starter-common:2.0.2&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.2&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.springframework:spring-aspects:6.0.8&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.flywaydb:flyway-core&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.postgresql:postgresql&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.apache.httpcomponents.client5:httpclient5:5.2.1&#34;</span><span class=p>)</span>

<span class=c1>// Для публикации в Кафку ЕМИАС выдаёт либу с джарником, которая работает с Кафкой напрямую...</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.apache.kafka:kafka-clients:3.2.1&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=nf>files</span><span class=p>(</span><span class=s>&#34;lib/client-lib-4.6.0.jar&#34;</span><span class=p>))</span>

<span class=nf>api</span><span class=p>(</span><span class=s>&#34;io.jsonwebtoken:jjwt-api:0.11.5&#34;</span><span class=p>)</span>
<span class=nf>runtimeOnly</span><span class=p>(</span><span class=s>&#34;io.jsonwebtoken:jjwt-impl:0.11.5&#34;</span><span class=p>)</span>
<span class=nf>runtimeOnly</span><span class=p>(</span><span class=s>&#34;io.jsonwebtoken:jjwt-jackson:0.11.5&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;com.fasterxml.jackson.module:jackson-module-kotlin&#34;</span><span class=p>)</span>
<span class=nf>implementation</span><span class=p>(</span><span class=s>&#34;org.jetbrains.kotlin:kotlin-reflect&#34;</span><span class=p>)</span>
<span class=nf>runtimeOnly</span><span class=p>(</span><span class=s>&#34;com.github.therapi:therapi-runtime-javadoc:0.15.0&#34;</span><span class=p>)</span>
<span class=nf>kapt</span><span class=p>(</span><span class=s>&#34;com.github.therapi:therapi-runtime-javadoc-scribe:0.15.0&#34;</span><span class=p>)</span></code></pre></div><p>Так же стоит уточнить, что я работаю на Linux (Manjaro, в частности) и если вы работаете на Windows, то мой опыт будет для вас ограничено полезен.</p></section><section class="doc-section level-1"><h2 id=_процесс><a class=link href=#_процесс>Процесс</a></h2><p>Первым делом почитал матчасть, выяснилось, что для сборки в натив достаточно поставить GraalVM и добавить одну строку в билд-файл.</p><p>Пока читал матчасть где-то попалось на глаза, что GraalVM проще всего поставить <a href=https://sdkman.io/>sdkman-ом</a>, так и сделал:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=shell>sdk <span class=nb>install </span>java 22.3.2.r17-nik</code></pre></div><p>Поставилось без проблем.
На рабочей машине.
А на ноуте в дороге до моей деревни sdkman тупил, но это был локальный глюк с интернетом, дома тоже нормально поставилось и у вас он врядли повториться.</p><p>Далее, добавил строку в билд-файл:</p><figure class=listing-block><figcaption>build.gradle.kts</figcaption><pre class="rouge highlight"><code data-lang=kotlin><span class=nf>plugins</span> <span class=p>{</span>
    <span class=nf>id</span><span class=p>(</span><span class=s>&#34;org.graalvm.buildtools.native&#34;</span><span class=p>)</span> <span class=n>version</span> <span class=s>&#34;0.9.24&#34;</span>
<span class=p>}</span></code></pre></figure><p>Запустил <code>nativeCompile</code> в Идее - взорвался из-за того что Градл запустился не на Граале.
Запустил в консоле - та же фигня.
Сделал фейспалм, переключил консоль на Грааль:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=shell>sdk use java 22.3.2.r17-nik</code></pre></div><p>Сборка пошла.</p><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Где-то между делом я видел, что вроде в блилд-файле можно что-то прописать, чтобы нативные сборки работали автоматом и вполне возможно это подтянется в Идею.
Но я пока не стал туда закапываться.</p></aside><p>И прошла с первого раза.</p><p>Я радостный запускаю свежескомпилинный и банрник и…​</p><div class=literal-block><pre>org.apache.kafka.common.config.ConfigException: Invalid value org.apache.kafka.common.serialization.StringSerializer for configuration key.serializer: Class org.apache.kafka.common.serialization.StringSerializer could not be found.
      at org.apache.kafka.common.config.ConfigDef.parseType(ConfigDef.java:744)
      at org.apache.kafka.common.config.ConfigDef.parseValue(ConfigDef.java:490)
      at org.apache.kafka.common.config.ConfigDef.parse(ConfigDef.java:483)</pre></div><p>Пошёл гуглить, нагуглил <a href=https://jeqo.github.io/posts/2022-03-18-kafka-clients-graalvm/>пост</a> ровно об этом.
Взял оттуда <code>kafka-client-reflection.json</code>, но как его прописать в сборку - не понятно, в посте пример для Мавена.
Потыкался через подсказки кода - ничего не нашёл, пошёл дальше гуглить.</p><p>Нагуглил <a href=https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html>официальную доку</a> по плагину GraalVM для Грэдла.
Попытался добавить как в примере:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=groovy><span class=n>binaries</span> <span class=o>{</span>
    <span class=n>main</span> <span class=o>{</span>
        <span class=n>buildArgs</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s1>&#39;--link-at-build-time&#39;</span><span class=o>)</span>
    <span class=o>}</span>
<span class=o>}</span></code></pre></div><p>Не скомпилировалось.
Потупил, понял что это в примере Groovy DSL, а у меня Kotlin DSL - переключил вкладку, поменял <code>main</code> на <code>named("main")</code> - собралось, запускаю…​</p><p>Фик, та же проблема.
Смотрю в файлик - там нет <code>StringSerializer</code>.
По аналогии добавляю его, собираю (и да, каждая сборка - 3 минуты) - успех!
Проект стартанул.</p><p>Дёргаю эндпоинт - работает!</p><p>Публикую сообщение в кролика и опять взрыв:</p><div class=literal-block><pre>kotlin.reflect.jvm.internal.KotlinReflectionInternalError: Unresolved class: class project_e.core.diary.api.dto.ActivityEventDto
      at kotlin.reflect.jvm.internal.KClassImpl.reportUnresolvedClass(KClassImpl.kt:328)
      at kotlin.reflect.jvm.internal.KClassImpl.access$reportUnresolvedClass(KClassImpl.kt:44)
      at kotlin.reflect.jvm.internal.KClassImpl$Data$descriptor$2.invoke(KClassImpl.kt:56)
      at kotlin.reflect.jvm.internal.KClassImpl$Data$descriptor$2.invoke(KClassImpl.kt:48)
      at kotlin.reflect.jvm.internal.ReflectProperties$LazySoftVal.invoke(ReflectProperties.java:93)
      at kotlin.reflect.jvm.internal.ReflectProperties$Val.getValue(ReflectProperties.java:32)
      at kotlin.reflect.jvm.internal.KClassImpl$Data.getDescriptor(KClassImpl.kt:48)
      at kotlin.reflect.jvm.internal.KClassImpl$Data$sealedSubclasses$2.invoke(KClassImpl.kt:154)
      at kotlin.reflect.jvm.internal.KClassImpl$Data$sealedSubclasses$2.invoke(KClassImpl.kt:153)
      at kotlin.reflect.jvm.internal.ReflectProperties$LazySoftVal.invoke(ReflectProperties.java:93)
      at kotlin.reflect.jvm.internal.ReflectProperties$Val.getValue(ReflectProperties.java:32)
      at kotlin.reflect.jvm.internal.KClassImpl$Data.getSealedSubclasses(KClassImpl.kt:153)
      at kotlin.reflect.jvm.internal.KClassImpl.getSealedSubclasses(KClassImpl.kt:259)
      at com.fasterxml.jackson.module.kotlin.KotlinAnnotationIntrospector.findSubtypes(KotlinAnnotationIntrospector.kt:97)</pre></div><p>Теперь не нашёлся код из нашей кодовой базы.
Потому что у нас эвенты (записи в дневнике) представляют из себя иерархию, маппинг которой в json настроен так:</p><div class=listing-block><pre class="rouge highlight"><code data-lang=kotlin><span class=nd>@JsonTypeInfo</span><span class=p>(</span>
    <span class=n>use</span> <span class=p>=</span> <span class=nc>JsonTypeInfo</span><span class=p>.</span><span class=nc>Id</span><span class=p>.</span><span class=nc>NAME</span><span class=p>,</span>
    <span class=n>include</span> <span class=p>=</span> <span class=nc>JsonTypeInfo</span><span class=p>.</span><span class=nc>As</span><span class=p>.</span><span class=nc>EXISTING_PROPERTY</span><span class=p>,</span>
    <span class=n>property</span> <span class=p>=</span> <span class=s>&#34;type&#34;</span>
<span class=p>)</span>
<span class=nd>@JsonSubTypes</span><span class=p>(</span>
    <span class=nc>JsonSubTypes</span><span class=p>.</span><span class=nc>Type</span><span class=p>(</span><span class=n>value</span> <span class=p>=</span> <span class=nc>ActivityEventDto</span><span class=o>::</span><span class=k>class</span><span class=p>,</span> <span class=n>name</span> <span class=p>=</span> <span class=s>&#34;ACTIVITY&#34;</span><span class=p>),</span>
    <span class=c1>// ...</span>
<span class=p>)</span>
<span class=k>sealed</span> <span class=kd>class</span> <span class=nc>EventDto</span><span class=p>(</span>
    <span class=kd>val</span> <span class=py>type</span><span class=p>:</span> <span class=nc>EventType</span>
<span class=p>)</span> <span class=p>{</span>
    <span class=c1>// ...</span>
<span class=p>}</span></code></pre></div><p>И не все типы напрямую используются в коде сервиса.</p><p>Завёл по аналогии ещё один файлик с рефлекшеном, прописал его в гредле, запустил сборку, покурил, публикую сообщение в кролик и успех!</p></section><section class="doc-section level-1"><h2 id=_результаты><a class=link href=#_результаты>Результаты</a></h2><p>На всё про всё - обзорный гуглёж, все тупняки, перекуры на сборки, прикручивание - у меня ушло часа 4.
А результы следующие:</p><div class=table-block><table class="frame-all grid-all stretch"><col style=width:33.3333%><col style=width:33.3333%><col style=width:33.3334%><tbody><tr><td class="halign-left valign-top"></td><td class="halign-left valign-top">Обычный билд</td><td class="halign-left valign-top">Билд в натив</td></tr><tr><td class="halign-left valign-top">Время сборки<sup>*</sup></td><td class="halign-left valign-top">8 c.</td><td class="halign-left valign-top">170 с.</td></tr><tr><td class="halign-left valign-top">Потребление памяти<sup>**</sup></td><td class="halign-left valign-top">433мб</td><td class="halign-left valign-top">205мб</td></tr><tr><td class="halign-left valign-top">Время запуска</td><td class="halign-left valign-top">4.5 с.</td><td class="halign-left valign-top">0.35 с.</td></tr></tbody></table></div><p>* Сборка без тестов</p><p>** После обработки одного HTTP-запроса и RabbitMQ-сообщения</p><p>Пока что я проделал все эти упражнения локально и впереди у нас сборка этого добра в GitLab, деплой в k8s и тщательное тестирование командой QA, но я смотрю в будущее с оптимизмом.</p></section></article></section></div></main><script src=/js/app.js></script></body></html>