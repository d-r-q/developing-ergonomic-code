<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Нотация описания неизменяемой модели данных - Алексей Жидков"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/microposts/23/11/immutable-relation-data-model-v2/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/microposts/23/11/immutable-relation-data-model-v2/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/microposts/23/11/immutable-relation-data-model-v2/><title>Нотация описания неизменяемой модели данных - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/microposts/23/11/immutable-relation-data-model-v2/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/ergo-approach/landing>Эргономичный подход</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/effects-diagram/landing>Диаграмма Эффектов</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Нотация описания неизменяемой модели данных</h1></header><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Этот материал является "микропостом" - текстом, написанным в режиме потока сознания без особой редактуры.</p><p>Следить за обновлениями блога можно в моём канале: <a href=https://t.me/ergonomic_code>Эргономичный код</a></p></aside><section class="doc-section level-1"><h2 id=_эргономичная_er_модель><a class=link href=#_эргономичная_er_модель>Эргономичная ER-модель</a></h2><section class="doc-section level-2"><h3 id=_общее_описание><a class=link href=#_общее_описание>Общее описание</a></h3><p>В основе моей нотации описания модели данных лежит классическая ER-модель и нотация вороньей лапки, с небольшими изменениями:</p><div class="olist arabic"><ol class=arabic><li>В нотацию вороньей лапки добавлено понятие слабой сущности из классической нотации;</li><li>В нотации вороньей лапки разделены владеющие (идентифицирующие в оригинальной терминалогии) отношения (между стержневой и слабой сущностью) и не владеющие отношения (между стержневыми сущностями);</li><li>Добавлено понятие контекста (аля DDD);</li><li>Добавлено понятие импортированной стержневой сущности - это сущность из контекста А, на которую есть ссылка в сущности в контексте Б;</li><li>Добавлено понятие логического агрегата (аля DDD) - это стержневая сущность и все её слабые сущности.</li></ol></div><p>Таким образом модель состит из элементов:</p><div class=ulist><ul><li>Контексты;
Обозначаются (большими) окрашенными прямоугольниками со скруглёнными углами.</li><li>Стержневые сущности (очень похожи на корни агрегатов в ДДД).
Обозначаются (маленьикими) окрашенными прямоугольниками со скруглёнными углами;</li><li>Слабые сущности (очень похожи на некорневые сущности и объекты-значения в ДДД).
Обозначаются (маленьикими) окрашенными прямоугольниками со скруглёнными углами и прерывистой границей;</li><li>Импортированные сущности.
Обозначаются (маленьикими) прямоугольниками окрашенными в цвет отличный от цвета контекста со скруглёнными углами и единственным атрибутом - ид;</li><li>Владеющие отношения.
Могут существовать как между стержневой и слабой, так и между слабыми сущностями.
Могут быть только 1-1 и 1-N.
Обозначаются сплошной стрелкой от стержневой к слабой сущности.</li><li>Невладеющие отношения.
Могут существовать между любыми типами сущностей.
Могут быть любой кардинальности - 1-1, 1-N, N-M.
Обозначаются прерывистой линией.</li></ul></div></section><section class="doc-section level-2"><h3 id=_пример><a class=link href=#_пример>Пример</a></h3><p>Для иллюстрации эргономичной ER-модели рассмотрим воображаемую блог-платформу.
Ключевыми сущностями являются пользователи и посты.
У пользователей есть фотография, у постов - авторы (множество) и комментарии.</p><p>Во имя иллюстрационных целей добавим ещё возможность авторам давать единственный ответ на комментарий.</p><p>Наконец, предположим, что путём вдумчивого анализа, мы пришли к выводу, что в этой системе есть два контекста - пользователи и посты.</p><p>Эргономичная ER-модель этой системы будет выглядеть так:</p><div class=image-block><img src=/microposts/23/11/images/eerm-example.drawio.svg alt="eerm example.drawio"></div><p>Здесь фото и комментарии я сделал слабыми сущностями, потому что они не могут существовать без пользователя и поста соответсвенно.
Также комментарий владеет другой слабой сущностью "Ответ".</p><p>С постами сложнее - они тоже не могут существовать без пользователя, но их жизнь не ограничена каким-то одним пользователем, а слабой сущностью может владеть только одна стержневая.
Поэтому посты я так же сделал стержневыми сущностями</p><p>Такая модель используется на этапе первичного анализа, но перед тем как перейти к реализации, её надо доработать для того, чтобы она хорошо на представление в виде неизменяемых деревьев структур данных, хранящихся в БД.</p></section></section><section class="doc-section level-1"><h2 id=_неизменяемая_er_модель><a class=link href=#_неизменяемая_er_модель>Неизменяемая ER-модель</a></h2><p>Доработка ER-модели заключается в:</p><div class="olist arabic"><ol class=arabic><li>Замене отношения N-M на связующую сущность, с отношениями 1-N с изначальными сущносятми;</li><li>Выявлении и обозначении отношения "1 к F(ew)".
Это специализация отношения 1-N, в котором участвует небольшое количество небольших сущностей*;</li><li>Превращении связующих сущностей в слабые, в случае если одно из отношений имеет кардинальность 1-F;</li><li>Превращении владеющих отношений, которые остались с кардинальностью 1-N (а не стали 1-F) в невладеющие.
И соответсвующие слабые сущности превратить в стержневые.
При этом атрибут-связь (список связей, если быть точным) надо перенести из бывшей владеющей сущности в бывшую слабую сущность (теперь в виде скаляра);</li><li>Превращении владеющих отношений 1-1 в невладеющие, если слабая сущность имеет большой размер (длинный текст, файл и т.д.).
В этом случае атрибут-ссылку можно как оставить в бывшей стержневой сущности, так и перенести в слабую.
Как выбирать?
По прниципу стабильных зависмостей - зависисимость должна быть от менее стабильной к более стабильной сущности.
Стабильность сущности определяется методом гадания на кофейной гущи.</li></ol></div><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>* Конкретное значение количества сущностей и их размер, которые можно счесть отношением 1-F, зависит от предметной области и технологии реализации.
В качестве первого приближения можно взять 20 сущностей в отношении с общим размером до 20 килобайт.</p></aside><p>В результате превращения владеющих отношений в невладеющие в модели появляются новые стержневые сущности, которые так же могут владеть слабыми сущностями.
Такие сущности я называю физическими агрегатами.</p><section class="doc-section level-2"><h3 id=_пример_2><a class=link href=#_пример_2>Пример</a></h3><p>Давайте проделаем эти шаги с нашей демо-моделью.</p><section class="doc-section level-3"><h4 id=_удаление_отношений_n_m><a class=link href=#_удаление_отношений_n_m>Удаление отношений N-M</a></h4><p>В модели у нас только одно отношение N-M - Пост-Пользователь.
Его можно заменить на сущность Автор (со связями 1-N с постом и пользователем).</p></section><section class="doc-section level-3"><h4 id=_поиск_отношений_1_f><a class=link href=#_поиск_отношений_1_f>Поиск отношений 1-F</a></h4><p>Теперь ищем отношения 1-F.</p><div class="olist arabic"><ol class=arabic><li>Пост-Автор.
Разумно предположить, что у поста будет не больше 20 авторов, так что обозначаем его как 1-F.</li><li>Пользователь-Автор.
А вот пользователь может написать неограниченное количество постов, поэтому оставляем отношение 1-N.</li><li>Пост-комментарий.
У поста может быть неограниченное количество комментариев - 1-N.</li><li>Пользователь-ответ.
Пользователь может ответить на неограниченное количество комментариев - 1-N.</li></ol></div></section><section class="doc-section level-3"><h4 id=_превращение_сущностей_связей_в_слабые_сущности><a class=link href=#_превращение_сущностей_связей_в_слабые_сущности>Превращение сущностей-связей в слабые сущности</a></h4><p>У нас есть только одна сущность-связь - Автор, и у неё есть отношение 1-F - Пост-Автор.
Так что делаем её слабой сущностью поста.</p></section><section class="doc-section level-3"><h4 id=_превращение_владеющих_отношений_1_n_в_невладеющие><a class=link href=#_превращение_владеющих_отношений_1_n_в_невладеющие>Превращение владеющих отношений 1-N в невладеющие</a></h4><p>У нас такое отношение одно - Пост-Комментарии.
Удаляем из поста атрибут "комментарии", добавляем в комментарий атрибут "пост", превращаем пост в стержневую сущность, меняем отношение на невладеющее.</p></section><section class="doc-section level-3"><h4 id=_превращение_владеющих_отношений_1_1_в_невладеющие><a class=link href=#_превращение_владеющих_отношений_1_1_в_невладеющие>Превращение владеющих отношений 1-1 в невладеющие.</a></h4><p>Комментарий владеет одним ответом и ответ - "лёгкая" сущность, поэтому тут можно оставить всё как есть.</p><p>А вот фото, которым владеет пользователь - "тяжёлая".
Поэтому превращаем её в стержневую сущность.</p><hr><p>После этого получаем модель, которая которую можно будет легко представить в виде неизменяемых структур данных, хранящихся в БД:</p><div class=image-block><img src=/microposts/23/11/images/ieerm-example.drawio.svg alt="ieerm example.drawio"></div></section></section></section><section class="doc-section level-1"><h2 id=_заключение><a class=link href=#_заключение>Заключение</a></h2><p>В этом посте я представил нотацию, которую использую для моделирования данных и дополнительные ограничения на модель, которые делают её пригодной для реализации в виде неизменяемых структур данных, хранящихся в БД.</p></section></article></section></div></main><script src=/js/app.js></script></body></html>