<!doctype html><html lang=ru-ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Алексей Жидков"><meta name=description content="https://azhidkov.pro/"><meta property="og:site_name" content="Алексей Жидков"><meta property="og:title" content="Гарантия отправки &#34;ровно один раз&#34; - Алексей Жидков"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://azhidkov.pro/microposts/23/06/exactly-once-send/"><meta property="og:image" content="https://azhidkov.pro/"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://azhidkov.pro/microposts/23/06/exactly-once-send/"><meta name=twitter:image content="https://azhidkov.pro/"><base href=https://azhidkov.pro/microposts/23/06/exactly-once-send/><title>Гарантия отправки "ровно один раз" - Алексей Жидков</title><link rel=canonical href=https://azhidkov.pro/microposts/23/06/exactly-once-send/><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css><link rel=stylesheet href=https://azhidkov.pro/css/custom.css><link rel=stylesheet href=https://azhidkov.pro/css/github.css><link rel=stylesheet href=https://azhidkov.pro/css/JetBrains-Mono.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://azhidkov.pro/index.xml type=application/rss+xml title="Алексей Жидков"><link href=https://azhidkov.pro/index.xml rel=feed type=application/rss+xml title="Алексей Жидков"><meta name=generator content="Hugo 0.80.0"></head><body><main class=wrapper><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://azhidkov.pro/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://azhidkov.pro/favicon-16x16.png><link rel=manifest href=site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link href="https://fonts.googleapis.com/css?family=Roboto" rel=stylesheet type=text/css><nav class=navigation><section class=container style=height:100%><img src=https://azhidkov.pro/images/logo.svg class=logo>
<a class=navigation-title href=/>Алексей Жидков</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/ergo-approach/landing>Эргономичный подход</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/effects-diagram/landing>Диаграмма Эффектов</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/posts>Блог</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/portfolio>Портфолио</a></li><li class="navigation-item align-left"><a class=navigation-link href=https://azhidkov.pro/>Контакты</a></li><li class=mobile-menu-lang-separator-full><hr></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Гарантия отправки "ровно один раз"</h1></header><aside class="admonition-block note" role=note><h6 class="block-title label-only"><span class=title-label>Note:</span></h6><p>Этот материал является "микропостом" - текстом, написанным в режиме потока сознания без особой редактуры.</p><p>Следить за обновлениями блога можно в моём канале: <a href=https://t.me/ergonomic_code>Эргономичный код</a></p></aside><p>В Проекте Э, мы интегрируемся с внешней системой, отправляя туда часть записей дневника пользователя по протоколу MQTT.
И коллеги попросили делать это ровно один раз.
Что невозможно в нашей вселенной.</p><p>Я написал для них обоснование невозможности выполнить их просьбу и решил это оформить в микропост в блог.</p><p>Строго говоря обеспечить обеспечить гарантию доставки “ровно один раз” невозможно.
Доказать невозможность обеспечения этой гарантии проще всего через приведение её к задаче <a href=https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B0_%D0%B4%D0%B2%D1%83%D1%85_%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D0%BB%D0%BE%D0%B2>двух генералов</a>, неразрешимость которой формально доказана в статье <a href=https://ru.wikipedia.org/wiki/%D0%9B%D1%8D%D0%BC%D0%BF%D0%BE%D1%80%D1%82,_%D0%9B%D0%B5%D1%81%D0%BB%D0%B8>Лесли Лэмпорта</a> (корифея теории распределённых систем, лауреата премии Тюринга) <a href=https://lamport.azurewebsites.net/pubs/solved-and-unsolved.pdf>“Solved Problems, Unsolved Problems and Problems in Concurrency”</a>, опубликованной в журнале Association for Computing Machinery - одном из старейших и уважаемых научных сообществ в области информатики.</p><p>Если упрощенно и переводя на наши реалии, мы не в состоянии выяснить причину отсутствия подтверждения получения события - проблемы с передачей сообщения (в случае чего отправку надо повторить) или задержка в обработке или проблемы с передачей подтверждения (в случае чего отправку повторять не надо).</p><p>Подробно и на русском доказательство описано в этой <a href=https://ru.hexlet.io/blog/posts/exactly-once>статье</a>.</p><p>Однако и сам MQTT предлагает гарантию доставки ровно один раз и в сети можно найти статьи, описывающие такую гарантию (<a href=https://exactly-once.github.io/posts/exactly-once-delivery/>1</a>, <a href=https://ably.com/blog/achieving-exactly-once-message-processing-with-ably>2</a>, <a href=https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/>3</a>, <a href=https://www.eejournal.com/2015/05/28/is-exactly-once-delivery-possible-with-mqtt/>4</a>).</p><p>Но если вчитаться в эти статьи, то они все опираются на то, что в случае сбоя отправка выполняется множество раз, но получатель выполняет дедупликацию на своей стороне.</p><p>И даже если предположить, что MQTT может гарантировать (хотя он гарантирует это только в случае сетевых сбоев, но не <a href=https://github.com/eclipse/paho.mqtt.c/issues/522#issuecomment-414636745>в случае сбоев постоянного хранилища</a> клиента или сервера), что сообщение уровня протокола будет доставлено один раз, мы со своей стороны не можем гарантировать отправку ровно одного MQTT-сообщения.</p><p>Проблема в том, для того чтобы гарантировать отправку всех событий, нам необходимо повторять отправку до тех пор, пока мы у себя в БД не пометим сообщение как отправленное.
Однако в распределенной системе может случиться такая последовательность:</p><div class=ulist><ul><li>Сервер отправляет сообщение;</li><li>MQTT выполняет успешную доставку и сообщает об этом серверу;</li><li>Сервер пытается отметить сообщение отправленным в БД;</li><li>Происходит сбой БД;</li><li>После восстановления работы БД, сервер не знает по какой причине помечено осталось не отправленным - сбой в доставке или сбой в пометке отправленным.</li></ul></div><p>Обычно дедупликацию делают на стороне получателя, но если получатель предоставит нам АПИ для проверки наличия у них события по идентификатору, мы сможем при повторной отправке выполнить дедупликацию на своей стороне.</p></article></section></div></main><script src=/js/app.js></script></body></html>