---
title: "Диаграмма эффектов: объектно-ориентированная декомпозиция"
description: "Этот пост является третьей частью из серии постов о диаграмме эффектов, в котором я расскажу как использовать диаграмму эффектов для объектно-ориентированной декомпозиции системы"
date: 2023-01-04T01:25:37+07:00
draft: false
---
:source-highlighter: rouge
:rouge-theme: github
:icons: font
:sectlinks:
:imagesdir: /drafts/effects-diagram/images

[NOTE]
--
Следить за обновлениями блога можно в моём канале: https://t.me/ergonomic_code[Эргономичный код]
--

== Введение

Года три назад у меня был "разговор у кулера" с коллегой, в котором я критиковал декомпозицию по слоям.
В ответ на это коллега сказал - "Ну это всё понятно. Но по другому-то как?".
На тот момент мне было нечего сказать, кроме общих слов вроде: "эээ... нууу... это же и есть работа архитектора, надо смотреть на каждый конкретный случай".

Поиск максимально понятного ответа на этот вопрос стал моей идеей фикс.
Спустя два года я его нашёл: "Систему надо декомпозировать на модули, инкапсулирующие эффекты".
Как это делать?
Это я раскладывал по полочкам ещё год.
И в результате у меня родилась ясная методика декомпозиции на базе эффектов.

== Декомпозиция на базе эффектов или объектно-ориентированная декомпозиция

(#todo: === почему всё-таки ОО-декомпозиция?#)

=== Зачем брать эффекты в основу декомпозиции?


Для начала договоримся, что эффект - это акт взаимодействия (чтения или записи) с глобальным состоянием.
Звучит, возможно, непонятно, но каждый программист ежедневно работает с эффектами.

Присваивание глобальной переменной, запись в файл, обращение к ресурсу REST API внешней системы, считывание текущего времени, обновление строки в реляционной БД - это всё эффекты.
А саму глобальную переменную, файл, ресурс REST API внешней системы, текущее время, строку реляционной БД - я называю ресурсами.

Система реализует свои операции посредством воздействия эффектами на ресурсы.

Но как лучше организовать операции, ресурсы и эффекты?
Я утверждаю, что лучше разбить их на такие группы (модули), чтобы каждая операция воздействовала только на ресурсы того же модуля.
Это позволит ограничить область действия операции состоянием этого модуля.
Что, в свою очередь, снизит сцепленность модулей системы, что и является одной из главных целей любого процесса дизайна.
Удостоверитсья в том, что декомопзиция качественная, можно с помощью проверки её на соответствие критериям.

=== Критерии качества декомпозиции

. В зависимостях между модулями не должно быть циклов.
  Для этого в декомпозиции не должно быть двух модулей, операции которых зависят от ресурсов друг друга;
. Количество эффектов записи, пересекающих границы модуля, должно быть минимальным.
  Вполне достижимый идеал - отсутствие таких эффектов;
. Количество эффектов чтения, пересекающих границы модуля должно быть минимальным.
+
С этим критерием надо быть осторожным, так как полное отсутствие эффектов пересекающих границы модуля может быть признаком помещения на одну диаграмму нескольких несвязанных систем или патологической расцпленности системы.
В первом случае диаграмму необходимо разбить на несколько.
А во втором - скрытую сцепленность через события лучше превратить в явную сцепленность через эффекты.

. Каждому модулю можно дать чёткое и лаконичное название, отражающее его содержание.

=== Этапы выполнения декомпозиции на базе эффектов

Объектно-ориентированная декомпозиция выполняется с помощью специально разработанного для этого инструмента - диаграммы эффектов.
Абстрактно декомпозиция состоит из двух больших шагов:

. Построение диаграммы эффектов на основе требований;
. Выполнение кластеризации диаграммы.
  Такие кластеры я в дальнейшем буду называть модулями.

Изначально в рамках Эргономичного подхода предполагалось построение диаграммы эффектов вручную и выполнение декомпозиции по специальному алгоритму кластеризации на базе эффектов.
Однако, уже после того, как я в общих чертах оформил объектно-ориентированную декомпозицию, я нашёл серию научных статей Дэвида Фейтельсона и др (#todo: линки на статьи#). с таким же по сути, но другим по механике подходом к декомпозиции.
(#todo: оно надо? про иронию?#)
По иронии, автор статей назвал свой подход функциональным.

В основе подхода Фейтельсона так же лежит двудольный граф операций и переменных состояния, связанный эффектами.
Но в отличие от моего подхода, он получает аналог диаграммы эффектов - визуализацию этого графа - автоматически с помощью graphviz, а декомпозирует эту визуализацию интуитивно.

Лично мне для визуализации больше нравится ручной подход, так как он позволяет лучше "прочувствовать" систему в процессе, и, как правило, даёт более презентабельный результат, который может служить документацией.
Но если у вас "аллергия" на построение диаграмм, то можно визуализацию выполнить автоматически с помощью graphviz.
В этом случае визуализацию надо будет немного донастроить, чтобы к ней можно было применить алгоритм из этого поста без изменений.
Донастройка заключается в раскраске стрелок эффектов записи и чтения в красный и синий цвет соответственно.
Для чего необходимо воспользоваться атрибутом `color`.

Так же, в дополнение к нотации диаграммы эффектов, кластеры в графе я обозначаю с помощью прямоугольников.

После того как визуализация получена, стоит попытаться быстро выполнить кластеризацию интуитивно и остановиться на этом, если получившаяся декомпозиция соответствует критерием качества.
Если получить качественную декомпозицию этим способом не удалось, то надо воспользоваться алгоритмом кластеризации на базе эффектов, который гарантированно даст качественный результат.

image::decomposition-algorithm.drawio.svg[]

Теперь рассмотрим выполнение объектно-ориентированной декомпозиции на практике.

== Декомпозиция диаграммы эффектов проекта TSP

=== Ручное построение диаграммы и интуитивная декомпозиция

И у в случае TSP увидеть такую декомпозицию можно и невооружённым глазом:

image::tsp-decomposition-intuitive-anim.drawio.png[]

=== Визуализация диаграммы с помощью graphviz и интуитивная декомпозиция

Авторы функциональной декомпозиции предлагают использовать для визуализации графа операций и ресурсов graphviz с алгоритмом раскладки NEATO.
Например, граф, аналогичный диаграмме эффектов проект TSP может быть закодирован так:

(#todo: расписать - как указать neato, как указать двойной вес эффектов записи, как указать цвета узлов и связей#)
[source,dot]
----
strict digraph  {
    overlap = scale
    sep = 0.5

    "Отправить фид в 2Гис" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Обновить фид для Яндекса" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Выдать фид Яндекса" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]

    "Загрузить изображение" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Скачать изображение" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Выдать список изображений организации" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Удалить изображение" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]

    "Перегенерировать фид" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]

    "Интеграция с 2Гис" [shape="rectangle" style="filled" fillcolor="#85bbf0"]
    "Фид Яндекса" [shape="rectangle" style="filled" fillcolor="#85bbf0"]

    "Изображения" [shape="rectangle" style="filled" fillcolor="#85bbf0"]

    "Организации" [shape="rectangle" style="filled" fillcolor="#85bbf0"]
    "Дополнительная информация" [shape="rectangle" style="filled" fillcolor="#85bbf0"]
    "Тема Сгенерирован новый фид" [shape="rectangle" style="filled" fillcolor="#85bbf0"]

    "Отправить фид в 2Гис" -> "Интеграция с 2Гис" [color="#b85450";weight=2]
    "Обновить фид для Яндекса" -> "Фид Яндекса" [color="#b85450";weight=2]

    "Загрузить изображение" -> "Изображения" [color="#b85450";weight=2]
    "Удалить изображение" -> "Изображения" [color="#b85450";weight=2]

    "Перегенерировать фид" -> "Тема Сгенерирован новый фид" [color="#b85450";weight=2]

    "Фид Яндекса" -> "Выдать фид Яндекса" [color="#6c8ebf";weight=1]

    "Изображения" -> "Скачать изображение" [color="#6c8ebf";weight=1]
    "Изображения" -> "Выдать список изображений организации" [color="#6c8ebf";weight=1]

    "Изображения" -> "Перегенерировать фид" [color="#6c8ebf";weight=1]
    "Организации" -> "Перегенерировать фид" [color="#6c8ebf";weight=1]
    "Дополнительная информация" -> "Перегенерировать фид" [color="#6c8ebf";weight=1]
}
----

И визуализирован так:

image::tsp-neato.svg[]

В этой визуализации группы, пожалуй, менее очевидны, но тем не менее видны и graphviz невозможно упрекнуть в подгонке результатов.

Но интуитивная декомпозиция хорошо работает только на простых графах.
На запутанных или достаточно больших графах группы могут быть не очевидны и иногда просто не понятно с какой стороны подойти к графу, чтобы начать выполнять декомопзицию.

=== Ручное построение диаграммы и декомпозиция по алгоритму

Теперь выполним по этому алгоритму декомпозицию диаграммы эффектов TSP, а для того чтобы сэмитировать "сложный" граф, я специально запутаю оригинальную диаграмму.

image::tsp-decomposition-algo-anim.drawio.png[]

Шаг 1: выбираем красную любую стрелку.
Для русского человека логично взять самую верхнюю левую стрелку - "Отправить фид в 2Гис".
Вытаскиваем стрелку с операцией и ресурсом из "мяса" и с радостью обнаруживаем, что за ними больше ничего не тянется и мы, похоже, сразу же нашли первый модуль - обводим его прямоугольником.

Шаг 2: выбираем следующую красную стрелку.
Пусть это будет "Сохранить изображение".
Вытягиваем её (вместе с операцией и ресурсом) в сторонку и обводим.
На этот раз у нас много стрелок ушло за границу

Шаг 3: подтягиваем внутрь модуля операции, которые зависят только от ресурса "Изображения".

Шаг 4: выбираем следующую стрелку - пусть это будет "Опубликовать новый фид".

Шаг 5: операций, связанных с ресурсом темы "Сгенерирован новый фид" больше нет, зато есть ресурсы, связанные с операцией "Перегенерировать фид" - подтягиваем их внутрь модуля.

Шаг 6: выбираем последнюю красную стрелку - "Сохранить фид Яндекса".
Обводим её.
И сразу подтягиваем последний оставшийся ресурс.

Шаг 7: даём имена прямоугольникам (в порядке появления).
"Интеграция с 2Гис", "Изображения", "Генерация фида", "Интеграция с Яндекс.Карты".

Тут, на мой взгляд, стоит остановиться и обратить внимание, что мы получили вполне разумную декомпозицию.
И это поразительно, потому что декомпозицию мы выполняли полностью механически оперируя только цветами стрелок и прямоугольников и их связями и пересечениями, абсолютно не учитывая семантику, скрывающуюся за этими геометрическими фигурами.
При желании, я уверен, этот алгоритм можно закодировать и выполнять такую декомпозицию полностью автоматически.
Но у такого подхода есть свои ограничения, и получить (в общем случае) идеальную декомпозицию предметной области, игнорируя саму предметную область невозможно.
Поэтому мы переходим к двум последним шагам, которые требуют понимания семантики и, соответвтенно, которые может выполнить только человек.

Шаг 8: выполняем обобщение.
На мой взгляд наглядность декомпозиции предметной области повысится, если мы скроем модули "Интеграция с 2Гис" и "Интеграция с Яндекс.Карты" в более абстрактном модуле "Интеграция с геосервисами".
Для этого мы добавим ещё один прямоугольник вокруг соответствующих модулей.

Шаг 9: применяем здравый смысл.
Внимательно смотрим на каждый модуль.
Что находится внутри?
Это согласуется с именем модуля?
От каких модулей он зависит?
Это разумно?
Сейчас на мой взгляд к самой декомпозиции уже не придраться.
Поэтому вместо здравого смысла мы применим творческое начало и немного "причешем" диаграмму, чтобы она смотрелась "аккуратно" на наш субъективный взгляд.

== Декомпозиция диаграммы эффектов проекта "Кэмп"

Но как я уже говорил, проект TSP вполне можно было декомпозировать и "на глаз", поэтому давайте дополнительно рассмотрим ещё декомпозицию по алгоритму немного упрощённой диаграммы эффектов проекта Кэмп.
Для того, чтобы нивелировать "предвзятость" диаграммы "разложенной" вручную, будем декомпозировать диаграмму "разложенную" graphviz-ом.

Для этого я перевёл руками +++<a href="../images/camp-effects.drawio.svg">исходную диаграмму</a>+++ в +++<a href="../images/camp-neato.graphviz" download>graphbiz-файл</a>+++, а затем сконвертировал его в svg-файл https://graphviz.org/docs/outputs/svg/[стандартными средствами]:

image::camp-neato.svg[]

[NOTE]
====
После перевода диаграммы в формат SVG, декомпозицию можно выполнять в любом редакторе векторной графики с поддержкой этого формата, например https://inkscape.org/[Inkscape].
====

Как видно, визуализация состоит из двух несвязанных графов - меньший граф, отражающий функциональность уведомлений, и больший граф отражающий основную функциональность системы.
В оригинальной диаграмме эти подграфы были связаны событием публикации сообщения о модерации точки, но для целей визуализации стрелки событий удаляются с диаграммы.

Так же для того чтобы визуализация стала более компактной и лучше смотрелись в на странице, я выделил несвязанные графы оригинальной визуализации в отдельные изображения и немного подправил раскладку графа основной функциональности:

image::camp-neato-main.svg[]

image::camp-neato-push.svg[]

Теперь давайте прогоним обе визуализации через алгоритм и начнём с графа основной функциональности Кэмпа.

// В третьем link:++{{<ref "posts/22/08/ergonomic-decomposition">}}++[посте] я объяснил почему мне не подошёл ни один из существующих подходов к декомпозиции и кратко описал объектно-ориентированный подход к декомпозиции на базе диаграммы эффектов.
// К этому посту важно сделать существенное дополнение.
// В том посте я голословно утверждал, что объектно-ориентированная декомпозиция даёт те же результаты, что и другие декомпозиции на базе предметной области (по фичам, по компонентам, DDD), но намного проще в применении.
// И после публикации этого поста я нашёл https://www.researchgate.net/publication/327229270_Identifying_Microservices_Using_Functional_Decomposition_4th_International_Symposium_SETTA_2018_Beijing_China_September_4-6_2018_Proceedings[академическую статью], в которой группа учёных описывает идентичный по сути подход к декомпозиции (но по иронии, они его называют функциональной декомпозицией) и приводит результаты экспериментов, которые свидетельствуют о том, что этот подход действительно даёт аналогичные результаты за существенно меньшее время ("часы" вместо "дней").
