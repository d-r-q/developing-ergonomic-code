---
title: "Диаграмма эффектов: объектно-ориентированная декомпозиция системы"
description: "Этот пост является третьей частью из серии постов о диаграмме эффектов, в котором я расскажу как использовать диаграмму эффектов для объектно-ориентированной декомпозиции системы"
date: 2023-01-04T01:25:37+07:00
draft: false
---
:source-highlighter: rouge
:rouge-theme: github
:icons: font
:sectlinks:
:imagesdir: /drafts/effects-diagram/images

[NOTE]
--
Следить за обновлениями блога можно в моём канале: https://t.me/ergonomic_code[Эргономичный код]
--

== Введение

Года два-три назад я рассказывал коллеге насколько плохО пакетирование по слоям.
В ответ он задал мне невинный вопрос - "А как по другому"?
На тот момент внятного ответа у меня не было, был только "нууу, надо смотреть на каждый конкретный случай".

Тот случай, я думаю, вполне можно назвать днём рождения Эргономичного подхода - именно желание найти внятный ответ на этот вопрос впоследствии превратилось в Эргономичный подход.
В итоге первые три года разработки ЭП преимущественно состояли из поиска, а потом изобретения и полировки ответа на вопрос "Как разбивать код на пакеты?".

И сейчас я вышел на финишуную прямую этой трёхлетней работы.
Ответ На Тот Самый Вопрос: "Код надо декомпозировать на модули, инкапсулирующие эффекты".
Что это значит?
Сейчас объясню.

== Декомпозиция на базе эффектов или объектно-ориентированная декомпозиция

Объектно-ориентированная декомпозиция выполняется с помощью специально разработанного для этого инструмента - диаграммы эффектов.
Абстрактно, декомпозиция состоит из двух больших шагов:

. Построение диаграммы эффектов на основе требований;
. Выполнение класетризации диаграммы.
  Такие кластеры я в дальнейшем буду называть модулями.

Изначально в рамках Эргономичного подхода, предполагалось построение диаграммы эффектов вручную и выполнение декомпозиции по специальному алгоритму - "Алгоритм объектно-ориентированной декомпозиции диаграммы эффектов".
Однако, уже после того, как я в общих чертах оформил объектно-ориентированную декомпозицию, я нашёл серию научных статей Дэвида Фейтельсон и др. с таким же по сути, но другим по механике подходом к декомпозиции.
По ироинии, авторы статей назвали свой подход функциональным.

В основе подхода Фейтельсона так же лежит двудольный граф операций и состояния, связанный эффектами.
Но отличае от моего подхода, он получает аналог диаграммы эффектов - визуализацию этого графа - автоматически с помощью graphviz, а декомпозирует эту визуализацию интуитивно.

Я включил идеи Фейтельсона в свой подход, и теперь объектно-ориентировнную декомопзицию можно выполнять четыремя способами:

. Визуализация через graphviz, декомпозиция "на глаз".
  Самый лёгкий, но самый ненадёжный способ.
  Хорошо рабоатет только для простых систем

. Визуализиация вручную, декомпозиция "на глаз".
  Сложнее чем, визуализация с помощью graphviz.
  Но за счёт этого помогает лучше понять систему и с большей вероятностью найти ошибки в дизайне системы.

. Визуализация через graphviz, декомпозиция по алгоритму.
  Лучше всего подходит для декомпозиции больших, но относительно простых систем

. Визуализация вручную, декомпозиция по алгоритму.
  Подходит для декомпозиции небольших, но запутанных систем.

Какой из них выбрать - зависит от ваших пердпочтений и сложности системы.

Способ визуализации - вручную или с помощью graphviz-а зависит преимущественно от ваших предпочтений.
graphviz позволяет получить визуализацию быстрее, чем если рисовать её руками.
Однако, процесс ручного рисования диаграммы поможет вам лучше прочуствовать струкутуру вашей системы.

Способ декомпозиции завист от вашего "глаза".
Если вы с первого взгляда видите "хорошую" декомпозицию, то можно обойтись интуитивной декомпозицией.

Как понять, что декомпозиция "хорошая"?
Декомпозиция хорошая, если она удволетворяет следующим критериям:

. В зависимостях между модулями не должно быть циклов.
  Для этого в декомпозиции не должно быть двух модулей, операции которых зависят от ресурсов друг друга
. Количество красных стрелок, пересекающих границы модуля, должно быть минимальным.
  Вполне достижимый идеал - отсутствие таких стрелок
. Количество синих стрелок, пересекающих границы модуля должно быть минимальным.
  Я ещё ни разу не встречал систем, для которой существовала естественная декомпозиция на полностью автономные модули.
+
Так может получиться только лишь если по каким-то причинам на одной диаграмме визуализировали несколько несвязанных между собой систем и очевидным решением тут будет разделить диаграмму на несколько.

+
Так же, при жгучем желании, этого можно добиться, выполнив паталогические расцепление модулей.
Но делать этого, очевидно, не стоит.
. У каждого модуля должно быть осмысленное имя.

Если "на глаз" хорошую декомпозицию не видно - можно взять тяжёлую артилерию прогнать диаграмму через алгоритм.
(#todo: как описать алгоритм?#)
Для этих случаев я разработал алгоритм декомпозиции диаграммы эффектов:

image::decomposition-algorithm.drawio.svg[]

Теперь рассмотрим выполнение объектно-ориентированной декомпозиции на практике.

== Декомпозиция диаграммы эффектов проекта TSP

=== Ручное построение диаграммы и интуитивная декомпозиция

И у в случае TSP увидеть такую декомпозицию можно и невооружённым глазом:

image::tsp-decomposition-intuitive-anim.drawio.png[]

=== Визуализация диаграммы с помощью graphviz и интуитивная декомпозиция

Авторы функциональной декомпозиции предлагают использовать для визуализации графа операций и ресурсов graphviz с алгоритмом раскладки NEATO.
Например, граф, аналогичный диаграмме эффектов проект TSP может быть закодирован так:

[source,dot]
----
strict digraph  {
    overlap = scale
    sep = 0.5

    "Отправить фид в 2Гис" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Обновить фид для Яндекса" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Выдать фид Яндекса" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]

    "Загрузить изображение" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Скачать изображение" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Выдать список изображений организации" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]
    "Удалить изображение" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]

    "Перегенерировать фид" [shape="rectangle" style="filled" fillcolor="#b6d7f0"]

    "Интеграция с 2Гис" [shape="rectangle" style="filled" fillcolor="#85bbf0"]
    "Фид Яндекса" [shape="rectangle" style="filled" fillcolor="#85bbf0"]

    "Изображения" [shape="rectangle" style="filled" fillcolor="#85bbf0"]

    "Организации" [shape="rectangle" style="filled" fillcolor="#85bbf0"]
    "Дополнительная информация" [shape="rectangle" style="filled" fillcolor="#85bbf0"]
    "Тема Сгенерирован новый фид" [shape="rectangle" style="filled" fillcolor="#85bbf0"]

    "Отправить фид в 2Гис" -> "Интеграция с 2Гис" [color="#b85450";weight=2]
    "Обновить фид для Яндекса" -> "Фид Яндекса" [color="#b85450";weight=2]

    "Загрузить изображение" -> "Изображения" [color="#b85450";weight=2]
    "Удалить изображение" -> "Изображения" [color="#b85450";weight=2]

    "Перегенерировать фид" -> "Тема Сгенерирован новый фид" [color="#b85450";weight=2]

    "Фид Яндекса" -> "Выдать фид Яндекса" [color="#6c8ebf";weight=1]

    "Изображения" -> "Скачать изображение" [color="#6c8ebf";weight=1]
    "Изображения" -> "Выдать список изображений организации" [color="#6c8ebf";weight=1]

    "Изображения" -> "Перегенерировать фид" [color="#6c8ebf";weight=1]
    "Организации" -> "Перегенерировать фид" [color="#6c8ebf";weight=1]
    "Дополнительная информация" -> "Перегенерировать фид" [color="#6c8ebf";weight=1]
}
----

И визуализирован так:

image::tsp-neato.svg[]

В этой визуализации группы, пожалуй, менее очевидны, но тем не менее видны и graphviz невозможно упрекнуть в подгонке результатов.

Но интуитивная декомпозиция хорошо работает только на простых графах.
На запутанных или достаточно больших графах группы могут быть не очевидны и иногда просто не понятно с какой стороны подойти к графу, чтобы начать выполнять декомопзицию.

=== Ручное построение диаграммы и декомпозиция по алгоритму

Теперь выполним по этому алгоритму декомпозицию диаграммы эффектов TSP, а для того чтобы сэмитировать "сложный" граф, я специально запутаю оригинальную диаграмму.

image::tsp-decomposition-algo-anim.drawio.png[]

Шаг 1: выбираем красную любую стрелку.
Для русского человека логично взять самую верхнюю левую стрелку - "Отправить фид в 2Гис".
Вытаскиваем стрелку с операцией и ресурсом из "мяса" и с радостью обнаруживаем, что за ними больше ничего не тянется и мы, похоже, сразу же нашли первый модуль - обводим его прямоугольником.

Шаг 2: выбираем следующую красную стрелку.
Пусть это будет "Сохранить изображение".
Вытягиваем её (вместе с операцией и ресурсом) в сторонку и обводим.
На этот раз у нас много стрелок ушло за границу

Шаг 3: подтягиваем внутрь модуля операции, которые зависят только от ресурса "Изображения".

Шаг 4: выбираем следующую стрелку - пусть это будет "Опубликовать новый фид".

Шаг 5: операций, связанных с ресурсом темы "Сгенерирован новый фид" больше нет, зато есть ресурсы, связанные с операцией "Перегенерировать фид" - подтягиваем их внутрь модуля.

Шаг 6: выбираем последнюю красную стрелку - "Сохранить фид Яндекса".
Обводим её.
И сразу подтягиваем последний оставшийся ресурс.

Шаг 7: даём имена прямоугольникам (в порядке появления).
"Интеграция с 2Гис", "Изображения", "Генерация фида", "Интеграция с Яндекс.Карты".

Тут, на мой взгляд, стоит остановиться и обратить внимание, что мы получили вполне разумную декомпозицию.
И это поразительно, потому что декомпозицию мы выполняли полностью механически оперируя только цветами стрелок и прямоугольников и их связями и пересечениями, абсолютно не учитывая семантику, скрывающуюся за этими геометрическими фигурами.
При желании, я уверен, этот алгоритм можно закодировать и выполнять такую декомпозицию полностью автоматически.
Но у такого подхода есть свои ограничения, и получить (в общем случае) идеальную декомпозицию предметной области, игнорируя саму предметную область невозможно.
Поэтому мы переходим к двум последним шагам, которые требуют понимания семантики и, соответвтенно, которые может выполнить только человек.

Шаг 8: выполняем обобщение.
На мой взгляд наглядность декомпозиции предметной области повысится, если мы скроем модули "Интеграция с 2Гис" и "Интеграция с Яндекс.Карты" в более абстрактном модуле "Интеграция с геосервисами".
Для этого мы добавим ещё один прямоугольник вокруг соответствующих модулей.

Шаг 9: применяем здравый смысл.
Внимательно смотрим на каждый модуль.
Что находится внутри?
Это согласуется с именем модуля?
От каких модулей он зависит?
Это разумно?
Сейчас на мой взгляд к самой декомпозиции уже не придраться.
Поэтому вместо здравого смысла мы применим творческое начало и немного "причешем" диаграмму, чтобы она смотрелась "аккуратно" на наш субъективный взгляд.

== Декомпозиция диаграммы эффектов проекта "Кэмп"

Но как я уже говорил, проект TSP вполне можно было декомпозировать и "на глаз", поэтому давайте дополнительно рассмотрим ещё декомпозицию по алгоритму немного упрощённой диаграммы эффектов проекта Кэмп.
Для того, чтобы нивелировать "предвзятость" диаграммы "разложенной" вручную, будем декомпозировать диаграмму "разложенную" graphviz-ом:

// В третьем link:++{{<ref "posts/22/08/ergonomic-decomposition">}}++[посте] я объяснил почему мне не подошёл ни один из существующих подходов к декомпозиции и кратко описал объектно-ориентированный подход к декомпозиции на базе диаграммы эффектов.
// К этому посту важно сделать существенное дополнение.
// В том посте я голословно утверждал, что объектно-ориентированная декомпозиция даёт те же результаты, что и другие декомпозиции на базе предметной области (по фичам, по компонентам, DDD), но намного проще в применении.
// И после публикации этого поста я нашёл https://www.researchgate.net/publication/327229270_Identifying_Microservices_Using_Functional_Decomposition_4th_International_Symposium_SETTA_2018_Beijing_China_September_4-6_2018_Proceedings[академическую статью], в которой группа учёных описывает идентичный по сути подход к декомпозиции (но по иронии, они его называют функциональной декомпозицией) и приводит результаты экспериментов, которые свидетельствуют о том, что этот подход действительно даёт аналогичные результаты за существенно меньшее время ("часы" вместо "дней").
