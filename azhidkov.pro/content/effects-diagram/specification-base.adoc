:rouge-theme: github
:icons: font
:sectlinks:

== История изменений

=== v0.1.0

(#todo: коммент#)

=== v0.0.2

. Изменение условного обозначения событий: отказ от представления отдельными блоками в пользу стрелок.
. Переход к использованию визуального языка C4 Model.

=== v0.0.1

Опубликована первая версия.

== Введение

Диаграмма эффектов — инструмент для разработчиков, предназначенный для визуализации поведения информационной системы через описание её взаимодействия с внешним миром.

Диаграмма эффектов полезна на всех этапах разработки ПО — от первичного анализа до планирования работ и поддержки. Она позволяет с минимальными затратами:

* получить целостную картину реализации будущей системы;
* оценить трудоёмкость разработки;
* декомпозировать систему на модули;
* определить порядок выполнения работ;
* уменьшить количество регрессий при внесении изменений в систему.

== Концептуальная модель

Максимально абстрактно, информационную систему можно представить как устройство по изменению состояния окружающего мира в ответ на изменения в окружающем мире.

В диаграмме эффектов такие устройства моделируются с помощью четырёх основных элементов:

. События - типы изменений в окружающем мире, на которые реагирует система;
. Ресурсы - части окружающего мира, которые система изменяет в процессе своей работы;
. Эффекты - атомарные единицы взаимодействия системы с окружающим миром;
. Операции - группы эффектов, образующие функции системы.

=== Событие

*Событие* - это обнаруженное изменение части окружающего мира.
Изменение определяется посредством сравнения текущего наблюдаемого состояния окружающего мира с его предыдущим известным состоянием.
В современных информационных системах отслеживанием изменений обычно занимаются низкоуровневые компоненты - операционные системы, middleware, фреймворки и библиотеки - поэтому на уровне прикладного приложения, события превращаются в вызов кода системы, переданного в такой компонент.

События могут генерироваться в следствии любого изменения, либо только в том случае предыдущее и/или текущее состояние определяет определённым условиям.

Примеры событий:

. Поступил HTTP-запрос;
. Появилось новое сообщение в очереди;
. Наступила полночь;
. Была нажата кнопка мыши.

В ответ на события, система реагирует новыми изменениями окружающего мира, части которого представлены в системе ресурсами.

=== Ресурс

*Ресурс* - это именованная область изменяемого состояния.
Такой областью может выступать:

. Глобальная переменная, хранящая примитивное значение;
. Таблица в реляционной БД;
. Топик очереди сообщений;
. ресурс REST API внешней системы.

Ресурсы предоставляют API для считывания и изменения своего состояния.

Система может быть настроена реагировать на события изменения собственного ресурса.
В этом случае события могут образовывать каскад - обработка события А порождает событие Б, которое вновь обрабатывается той же системой и может привести к порождению события В и т.д.

Как правило, реагирует на изменения в специализированных ресурсах, вроде топика очереди сообщений.
Но, например, при помощи триггеров и оператора NOTIFY в PostgreSQL, можно реализовать порождение события и в результате изменения ресурса реляционной таблицы.

Вызовы API ресурсов являются эффектами работы системы.

=== Эффект

*Эффект* — это атомарный на данном уровне абстракции акт считывания или изменения некоторого состояния (ресурса).

Эффекты чтения характеризуются тем, что считывание одного и того же состояния в разные моменты времени может дать разные результаты.
А эффекты изменения (или записи) характеризуются тем, что изменённое состояние можно наблюдать за пределами текущего фрейма стэка потока выполнения.

Примеры эффектов:

* чтение и запись статической переменной;
* чтение и запись файла;
* выборка или обновление данных в таблице реляционной БД;
* отправка HTTP-запросов.

Атомарный на одном уровне эффект, может быть реализован несколькими эффектами на более низком уровне.
Например эффект вставки строки в таблицу РСУБД, в самой РСУБД приведёт к целой группе эффектов - считывание и запись страницы таблицы, считывание и запись страниц индексов таблицы, обновление последовательности генерации первичных ключей и т.д.

С другой стороны, группа эффектов того же уровня, на более высоком уровне будет выглядеть атомарной.
Такая группа эффектов образует операцию системы.

=== Операция

*Операция* - это атомарная единица полезной работы, которую система предоставляет для своих пользователей.
В процессе своей работы, операция, как правило, выполняет один или несколько эффектов чтения и записи.

Система реагирует на события именно посредством операций.
Система может реагировать несколькими операциями в ответ на одно событие или наоборот реагировать одной и той же операцией, в ответ на разные события.

== Применение

Диаграмма эффектов даёт чёткое представление об операциях системы, необходимое на всех этапах жизненного цикла разработки.

. На этапе *поддержки и развития* диаграмма позволяет описать текущее наблюдаемое поведение системы и спрогнозировать, как оно поменяется после внесения изменений в систему. Благодаря этому можно заметить нежелательные изменения и, таким образом, избежать регрессий.

. На этапе *анализа требований* к системе диаграмма эффектов помогает переформулировать требования в абстракциях будущей программы.

. На этапе *оценки* диаграмма позволяет точнее определить состав работ (на основе списка операций) и трудоёмкость (на основе списка событий, требуемых эффектов и целевых ресурсов).

. На этапе *проектирования системы* операции и ресурсы диаграммы становятся ключевыми блоками, правильная декомпозиция которых поможет создать основу для системы с низкой сцепленностью.

. На этапе *реализации* взаимосвязь операций через ресурсы помогает определить порядок выполнения работ и те работы, которые могут быть выполнены параллельно.

== Нотация

В основе визуального языка диаграммы эффектов лежит язык https://c4model.com/[модели C4].
Это позволяет встраивать диаграмму эффектов в модель C4 на четвёртом уровне — в качестве диаграммы кода.

Нотация диаграммы эффектов бывает двух типов — краткая и полная.

=== Краткая нотация

В краткой нотации используются 4 элемента, которые составляют ядро диаграммы эффектов:

* операции;
* ресурсы;
* эффекты;
* примечания.

=== Полная нотация

В полной нотации добавляются элементы:

* события;
* описания операций и ресурсов в формате модели C4;
* границы контейнера из C4;
* внешние системы, базы данных и компоненты из C4.

Расширять состав диаграммы можно постепенно, добавляя только те элементы, которые помогают в решении текущей задачи.

=== Критерии выбора нотации

*Краткая нотация* подойдёт, если:

* требуется быстро разбить систему на модули;
* необходимо спланировать модификацию сложной или незнакомой операции;
* диаграмму будет использовать только автор в течение непродолжительного времени и повторное возвращение к ней не планируется.

*Полная нотация* рекомендуется, если:

* нужно оценить проект для работы за фиксированную цену и минимизировать вероятность потери существенных деталей;
* планируется опубликовать диаграмму или использовать её через длительный срок после создания.

=== Пример диаграммы эффектов

Оба вида нотации рассматриваются на примере визуализации процесса регистрации и аутентификации пользователей в произвольной системе. После успешной регистрации пользователям отправляется приветственное письмо.

Диаграмма эффектов с использованием краткой нотации:

image::short-notation-example.png[link={imagesdir}/short-notation-example.png]

Диаграмма эффектов с использованием полной нотации:

image::full-notation-example.png[link={imagesdir}/full-notation-example.png]

=== Элементы диаграммы эффектов

==== Операции

Операции обозначаются прямоугольником с именем операции:

image::operation.png[]

==== Ресурсы

Ресурсы обозначаются прямоугольником с именем ресурса и цветом, отличным от цвета операции:

image::resource.png[]

==== Эффекты

*Эффект модификации ресурса* обозначается утолщённой линией со стрелкой от операции к ресурсу и сопровождается кратким описанием эффекта:

image::operation-resource-rw.png[]

*Эффект чтения ресурса* обозначается обычной линией со стрелкой от ресурса к операции и сопровождается кратким описанием считываемых данных:

image::operation-resource-ro.png[]

==== Примечания

На диаграмму можно помещать заметки и примечания.
Рекомендуемое обозначение *примечаний* — «лист» с загнутым углом, связанный прерывистой линией с комментируемым элементом, но можно использовать и обозначения из других нотаций.

image::note.png[]

==== События

*События* обозначаются обычной линией с кругом в начале и стрелкой на конце.
Стрелка направлена от внешней системы или ресурса-источника к операции и сопровождается описанием в формате C5.

В промежуточной версии диаграммы изображение внешней системы можно опустить:

image::event-operation.png[]

==== Описания

Для блоков операций можно указать тип, способ реализации и описание:

image::descriptions.png[]

==== Границы контейнера и внешние системы

Элементы, обозначающие границы системы и внешние системы, полностью соответствуют нотации C4:

* границы системы обозначаются прямоугольником с указанием имени контейнера, для контура прямоугольника используется светло-серая прерывистая линия;
* управляемые внешние системы и базы данных обозначаются прямоугольником и символом «База данных»;
* неуправляемые внешние системы и компоненты обозначаются прямоугольниками светло-серого цвета;
* неуправляемые базы данных обозначаются светло-серым символом «База данных».

==== Связь внешних систем с другими элементами диаграммы

Внешние системы связываются с *операциями* посредством *событий*:

image::event-sources.png[]

*Ресурсы* связываются с внешними системами посредством *стрелок с описанием*:

image::resource-impls.png[]

==== Связь ресурсов со сторонними компонентами

*Ресурс* может быть связан со сторонним компонентом, работающим в том же процессе.

(#todo: заменить стрелку на чёрную#)

image::resource-component.png[]

== Приложение 1. Инструментарий

Диаграмма эффектов основана на визуальном языке модели C4, поэтому для её построения можно использовать https://c4model.com/#Tooling[любой инструмент с поддержкой C4].

== Приложение 2. Реализация концептуальной модели в коде

Все элементы, описанные в концептуальной модели, транслируются непосредственно в код: события и операции — в методы, ресурсы — в классы, эффекты — в вызовы методов.

*Операции* всегда транслируются в методы классов (слой сервисов приложения), т.е. в методы, определяющие публичный интерфейс системы.
При реализации этих методов желательно сохранить взаимосвязь эффектов и операций, представленную на диаграмме: методы должны содержать в себе столько же вызовов методов классов-ресурсов, сколько стрелок у соответствующей операции на диаграмме.

*Ресурсы* превращаются в структуру данных и коллекцию методов работы с ней. Это могут быть классы Spring Data агрегата и репозитория, классы события и интерфейса ApplicationEventPublisher (или обёртки вокруг него), классы REST API модели и клиента и т.п.

В контексте бэкендов информационных систем самыми распространёнными видами ресурсов являются:

* любые постоянные коллекции данных — таблицы в реляционной СУБД, коллекции в документной СУБД и т.д.;
* REST API внешних сервисов;
* любые очереди сообщений и шины событий;
* изменяемые структуры данных, доступные через глобальные переменные.

*События* превращаются в методы, передаваемые фреймворку для последующего вызова. Например, в метод класса контроллера (RestController в Spring), слушателю (EventListener в Swing), в реализацию Runnable для таймера и т.д.

В контексте бэкендов информационных систем самыми распространёнными видами событий являются:

* получение запроса по сети (@RestController + @*Mapping в случае разработки на Spring).
  Сейчас популярностью пользуется протокол запросов в REST-стиле, но SOAP, gRPC, CORBA и т.п. также попадают в эту категорию;
* появление сообщения в очереди (@JmsListener);
* доменное событие или событие приложения (@EventListener);
* наступление определённого момента времени (@Scheduled). Два основных типа таких событий:
** наступление заранее известного момента времени (например, полночь вторника);
** истечение определённого времени с момента в прошлом (например, истечение суток с момента создания предыдущего бэкапа).
